<!doctype html>
<html lang="zh-CN">
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>MongoDB之旅(上) | ￥ЯႭ1I0</title>
    <meta property="og:title" content="MongoDB之旅(上) - ￥ЯႭ1I0">
    <meta property="og:type" content="article">
        
    <meta property="article:published_time" content='2017-03-22T23:29:34&#43;08:00'>
        
        
    <meta property="article:modified_time" content='2017-03-22T23:29:34&#43;08:00'>
        
    <meta name="Keywords" content="">
    <meta name="description" content="MongoDB之旅(上)">
        
    <meta name="author" content="yrq110">
    <meta property="og:url" content="http://yrq110.me/post/database/mongo-travel-part-1/">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">

    <link rel="stylesheet" href='/css/normalize.css'>
    <link rel="stylesheet" href='/css/style.css'>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

    


    
    
</head>


<body>
    <header id="header" class="clearfix">
    <div class="container">
        <div class="col-group">
            <div class="site-name ">
                
                    <a id="logo" href="http://yrq110.me/">
                        ￥ЯႭ1I0
                    </a>
                
                
            </div>
            <div>
                <nav id="nav-menu" class="clearfix">
                    <a class="current" href="http://yrq110.me/">首页</a>
                    
                    <a  href="http://yrq110.me/archives/" title="归档">归档</a>
                    
                    <a  href="http://yrq110.me/about/" title="关于">关于</a>
                    
                </nav>
            </div>
        </div>
    </div>
</header>

    <div id="body">
        <div class="container">
            <div class="col-group">

                <div class="col-8" id="main">
                    
<div class="res-cons">
    
    <article class="post">
        <header>
            <h1 class="post-title">MongoDB之旅(上)</h1>
        </header>
        <date class="post-meta meta-date">
            2017年3月22日
        </date>
        
        <div class="post-meta">
            <span>|</span>
            
            <span class="meta-category"><a href='http://yrq110.me/categories/database'>database</a></span>
            
        </div>
        
        
        
        <div class="post-content">
            <p>介绍数据类型、shell、基本操作等内容</p>
<p><em>本文所使用的MongoDB版本为3.4.2</em></p>
<h2 id="数据类型">数据类型</h2>
<p>在JSON键值对的基础上增加了其它通用类型:</p>
<ul>
<li>null</li>
<li>布尔型 - true&amp;false</li>
<li>数值 - shell默认为64位浮点数，对于整数可使用NumberInt</li>
<li>字符串</li>
<li>日期 - new Date()</li>
<li>正则表达式</li>
<li>数组</li>
<li>内嵌文档</li>
<li>对象id - 12字节id，文档唯一标识。_id和ObjectId键值对</li>
<li>二进制数据 - 二进制字符串，不能直接在shell中使用</li>
<li>代码 - 包含任意JavaScript代码</li>
</ul>
<h2 id="objectid">ObjectId</h2>
<p>共12个字节:</p>
<ul>
<li>0-3 时间戳</li>
<li>4-6 机器</li>
<li>7-8 PID</li>
<li>9-12 计数器</li>
</ul>
<h2 id="shell">shell</h2>
<ol>
<li>
<p>无连接进入shell</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">mongo --nodb
</code></pre></div></li>
<li>
<p>启动mongo</p>
</li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">mongod --dbpath /Users/yrq/Desktop/db
</code></pre></div><ol start="3">
<li>连接</li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">mongo
<span style="color:#75715e">#默认地址是mongodb://127.0.0.1:27017</span>
</code></pre></div><ol start="4">
<li>查看库和集合</li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># 1.查看库</span>
&gt; show dbs
admin  0.000GB
local  0.000GB
test   0.000GB
<span style="color:#75715e"># 2.显示当前库</span>
&gt; db
test
<span style="color:#75715e"># 3.显示当前库的集合</span>
&gt; show collections
foo
users
</code></pre></div><h2 id="基本操作">基本操作</h2>
<h3 id="插入">插入</h3>
<h4 id="单个插入">单个插入</h4>
<p>使用insert方法，接受一个文档对象。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">&gt; string <span style="color:#f92672">=</span> <span style="color:#f92672">{</span><span style="color:#e6db74">&#34;content&#34;</span>:<span style="color:#e6db74">&#34;Hello mongo&#34;</span><span style="color:#f92672">}</span>
<span style="color:#f92672">{</span> <span style="color:#e6db74">&#34;content&#34;</span> : <span style="color:#e6db74">&#34;Hello mongo&#34;</span> <span style="color:#f92672">}</span>
&gt; db.foo.insert<span style="color:#f92672">(</span>string<span style="color:#f92672">)</span>
&gt; db.foo.find<span style="color:#f92672">()</span>
<span style="color:#f92672">{</span> <span style="color:#e6db74">&#34;_id&#34;</span> : ObjectId<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;58e0d8ae0eb1a56f1497eda5&#34;</span><span style="color:#f92672">)</span>, <span style="color:#e6db74">&#34;content&#34;</span> : <span style="color:#e6db74">&#34;Hello mongo&#34;</span> <span style="color:#f92672">}</span>
</code></pre></div><h4 id="批量插入">批量插入</h4>
<p>使用insert方法(在mongo3.2.3中batchInsert方法被弃用)，接受文档数组作为参数</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">&gt; db.foo.insert<span style="color:#f92672">([{</span><span style="color:#e6db74">&#34;no&#34;</span>:1<span style="color:#f92672">}</span>,<span style="color:#f92672">{</span><span style="color:#e6db74">&#34;no&#34;</span>:2<span style="color:#f92672">}</span>,<span style="color:#f92672">{</span><span style="color:#e6db74">&#34;no&#34;</span>:3<span style="color:#f92672">}])</span>
BulkWriteResult<span style="color:#f92672">({</span>
	<span style="color:#e6db74">&#34;writeErrors&#34;</span> : <span style="color:#f92672">[</span> <span style="color:#f92672">]</span>,
	<span style="color:#e6db74">&#34;writeConcernErrors&#34;</span> : <span style="color:#f92672">[</span> <span style="color:#f92672">]</span>,
	<span style="color:#e6db74">&#34;nInserted&#34;</span> : 3,
	<span style="color:#e6db74">&#34;nUpserted&#34;</span> : 0,
	<span style="color:#e6db74">&#34;nMatched&#34;</span> : 0,
	<span style="color:#e6db74">&#34;nModified&#34;</span> : 0,
	<span style="color:#e6db74">&#34;nRemoved&#34;</span> : 0,
	<span style="color:#e6db74">&#34;upserted&#34;</span> : <span style="color:#f92672">[</span> <span style="color:#f92672">]</span>
<span style="color:#f92672">})</span>
&gt; db.foo.find<span style="color:#f92672">()</span>
<span style="color:#f92672">{</span> <span style="color:#e6db74">&#34;_id&#34;</span> : ObjectId<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;58e1ab966c4ede97e9d75aab&#34;</span><span style="color:#f92672">)</span>, <span style="color:#e6db74">&#34;no&#34;</span> : <span style="color:#ae81ff">1</span> <span style="color:#f92672">}</span>
<span style="color:#f92672">{</span> <span style="color:#e6db74">&#34;_id&#34;</span> : ObjectId<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;58e1ab966c4ede97e9d75aac&#34;</span><span style="color:#f92672">)</span>, <span style="color:#e6db74">&#34;no&#34;</span> : <span style="color:#ae81ff">2</span> <span style="color:#f92672">}</span>
<span style="color:#f92672">{</span> <span style="color:#e6db74">&#34;_id&#34;</span> : ObjectId<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;58e1ab966c4ede97e9d75aad&#34;</span><span style="color:#f92672">)</span>, <span style="color:#e6db74">&#34;no&#34;</span> : <span style="color:#ae81ff">3</span> <span style="color:#f92672">}</span>
</code></pre></div><h3 id="删除">删除</h3>
<p>使用remove方法，删除无法撤销也无法恢复。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">&gt; db.foo.remove<span style="color:#f92672">({})</span>
WriteResult<span style="color:#f92672">({</span> <span style="color:#e6db74">&#34;nRemoved&#34;</span> : <span style="color:#ae81ff">3</span> <span style="color:#f92672">})</span>
&gt; db.foo.find<span style="color:#f92672">()</span>
&gt;
</code></pre></div><h3 id="更新">更新</h3>
<p>使用update方法,接受一个查询和一个更新对象。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">&gt; string.date <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;20170403&#34;</span>
<span style="color:#ae81ff">20170403</span>
&gt; db.foo.update<span style="color:#f92672">({</span><span style="color:#e6db74">&#34;content&#34;</span>:<span style="color:#e6db74">&#34;Hello mongo&#34;</span><span style="color:#f92672">}</span>,string<span style="color:#f92672">)</span>
WriteResult<span style="color:#f92672">({</span> <span style="color:#e6db74">&#34;nMatched&#34;</span> : 1, <span style="color:#e6db74">&#34;nUpserted&#34;</span> : 0, <span style="color:#e6db74">&#34;nModified&#34;</span> : <span style="color:#ae81ff">1</span> <span style="color:#f92672">})</span>
&gt; db.foo.find<span style="color:#f92672">()</span>
<span style="color:#f92672">{</span> <span style="color:#e6db74">&#34;_id&#34;</span> : ObjectId<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;58e0d8ae0eb1a56f1497eda5&#34;</span><span style="color:#f92672">)</span>, <span style="color:#e6db74">&#34;content&#34;</span> : <span style="color:#e6db74">&#34;Hello mongo&#34;</span>, <span style="color:#e6db74">&#34;date&#34;</span> : <span style="color:#e6db74">&#34;20170403&#34;</span> <span style="color:#f92672">}</span>
</code></pre></div><h4 id="使用修改器">使用修改器</h4>
<ol>
<li>
<p>&ldquo;$set&rdquo; - 指定字段的值，若不存在则创建</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">&gt; db.foo.update<span style="color:#f92672">({</span><span style="color:#e6db74">&#34;content&#34;</span>:<span style="color:#e6db74">&#34;Hello mongo&#34;</span><span style="color:#f92672">}</span>,<span style="color:#f92672">{</span><span style="color:#e6db74">&#34;</span>$set<span style="color:#e6db74">&#34;</span>:<span style="color:#f92672">{</span><span style="color:#e6db74">&#34;user&#34;</span>:<span style="color:#e6db74">&#34;yrq&#34;</span>,<span style="color:#e6db74">&#34;content&#34;</span>:<span style="color:#e6db74">&#34;Hello&#34;</span><span style="color:#f92672">}})</span>
WriteResult<span style="color:#f92672">({</span> <span style="color:#e6db74">&#34;nMatched&#34;</span> : 1, <span style="color:#e6db74">&#34;nUpserted&#34;</span> : 0, <span style="color:#e6db74">&#34;nModified&#34;</span> : <span style="color:#ae81ff">1</span> <span style="color:#f92672">})</span>
&gt; db.foo.find<span style="color:#f92672">()</span>
<span style="color:#f92672">{</span> <span style="color:#e6db74">&#34;_id&#34;</span> : ObjectId<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;58e1be6cb6647fe45f462cf2&#34;</span><span style="color:#f92672">)</span>, <span style="color:#e6db74">&#34;content&#34;</span> : <span style="color:#e6db74">&#34;Hello&#34;</span>, <span style="color:#e6db74">&#34;user&#34;</span> : <span style="color:#e6db74">&#34;yrq&#34;</span> <span style="color:#f92672">}</span>
</code></pre></div></li>
<li>
<p>&ldquo;$inc&rdquo; - 指定增加或减少已有键的值，若不存在则创建后加上设置的值</p>
<p>比如用户yrq评论精彩，增加了500分:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">&gt; db.foo.update<span style="color:#f92672">({</span><span style="color:#e6db74">&#34;user&#34;</span>:<span style="color:#e6db74">&#34;yrq&#34;</span><span style="color:#f92672">}</span>,<span style="color:#f92672">{</span><span style="color:#e6db74">&#34;</span>$inc<span style="color:#e6db74">&#34;</span>:<span style="color:#f92672">{</span><span style="color:#e6db74">&#34;score&#34;</span>:500<span style="color:#f92672">}})</span>
WriteResult<span style="color:#f92672">({</span> <span style="color:#e6db74">&#34;nMatched&#34;</span> : 1, <span style="color:#e6db74">&#34;nUpserted&#34;</span> : 0, <span style="color:#e6db74">&#34;nModified&#34;</span> : <span style="color:#ae81ff">1</span> <span style="color:#f92672">})</span>
&gt; db.foo.find<span style="color:#f92672">()</span>
<span style="color:#f92672">{</span> <span style="color:#e6db74">&#34;_id&#34;</span> : ObjectId<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;58e1be6cb6647fe45f462cf2&#34;</span><span style="color:#f92672">)</span>, <span style="color:#e6db74">&#34;content&#34;</span> : <span style="color:#e6db74">&#34;Hello&#34;</span>, <span style="color:#e6db74">&#34;user&#34;</span> : <span style="color:#e6db74">&#34;yrq&#34;</span>, <span style="color:#e6db74">&#34;score&#34;</span> : <span style="color:#ae81ff">500</span> <span style="color:#f92672">}</span>
</code></pre></div><p>然后用户yrq又发了一条违规信息，减少了1000分:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">&gt; db.foo.update<span style="color:#f92672">({</span><span style="color:#e6db74">&#34;user&#34;</span>:<span style="color:#e6db74">&#34;yrq&#34;</span><span style="color:#f92672">}</span>,<span style="color:#f92672">{</span><span style="color:#e6db74">&#34;</span>$inc<span style="color:#e6db74">&#34;</span>:<span style="color:#f92672">{</span><span style="color:#e6db74">&#34;score&#34;</span>:-1000<span style="color:#f92672">}})</span>
WriteResult<span style="color:#f92672">({</span> <span style="color:#e6db74">&#34;nMatched&#34;</span> : 1, <span style="color:#e6db74">&#34;nUpserted&#34;</span> : 0, <span style="color:#e6db74">&#34;nModified&#34;</span> : <span style="color:#ae81ff">1</span> <span style="color:#f92672">})</span>
&gt; db.foo.find<span style="color:#f92672">()</span>
<span style="color:#f92672">{</span> <span style="color:#e6db74">&#34;_id&#34;</span> : ObjectId<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;58e1be6cb6647fe45f462cf2&#34;</span><span style="color:#f92672">)</span>, <span style="color:#e6db74">&#34;content&#34;</span> : <span style="color:#e6db74">&#34;Hello&#34;</span>, <span style="color:#e6db74">&#34;user&#34;</span> : <span style="color:#e6db74">&#34;yrq&#34;</span>, <span style="color:#e6db74">&#34;score&#34;</span> : -500 <span style="color:#f92672">}</span>
</code></pre></div></li>
<li>
<p>&ldquo;$push&rdquo; - 若数组存在则在尾部添加元素，不存在则创建</p>
<p>用户yrq看完了一本书，需要添加到用户信息中:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">&gt; db.foo.update<span style="color:#f92672">({</span><span style="color:#e6db74">&#34;user&#34;</span>:<span style="color:#e6db74">&#34;yrq&#34;</span><span style="color:#f92672">}</span>,<span style="color:#f92672">{</span><span style="color:#e6db74">&#34;</span>$push<span style="color:#e6db74">&#34;</span>:<span style="color:#f92672">{</span><span style="color:#e6db74">&#34;books&#34;</span>:<span style="color:#f92672">{</span><span style="color:#e6db74">&#34;book&#34;</span>:<span style="color:#e6db74">&#34;Know JS&#34;</span>,<span style="color:#e6db74">&#34;author&#34;</span>:<span style="color:#e6db74">&#34;aaa&#34;</span><span style="color:#f92672">}}})</span>
WriteResult<span style="color:#f92672">({</span> <span style="color:#e6db74">&#34;nMatched&#34;</span> : 1, <span style="color:#e6db74">&#34;nUpserted&#34;</span> : 0, <span style="color:#e6db74">&#34;nModified&#34;</span> : <span style="color:#ae81ff">1</span> <span style="color:#f92672">})</span>
&gt; db.foo.find<span style="color:#f92672">()</span>
<span style="color:#f92672">{</span> <span style="color:#e6db74">&#34;_id&#34;</span> : ObjectId<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;58e1be6cb6647fe45f462cf2&#34;</span><span style="color:#f92672">)</span>, <span style="color:#e6db74">&#34;content&#34;</span> : <span style="color:#e6db74">&#34;Hello&#34;</span>, <span style="color:#e6db74">&#34;user&#34;</span> : <span style="color:#e6db74">&#34;yrq&#34;</span>, <span style="color:#e6db74">&#34;books&#34;</span> : <span style="color:#f92672">[</span> <span style="color:#f92672">{</span> <span style="color:#e6db74">&#34;book&#34;</span> : <span style="color:#e6db74">&#34;Know JS&#34;</span>, <span style="color:#e6db74">&#34;author&#34;</span> : <span style="color:#e6db74">&#34;aaa&#34;</span> <span style="color:#f92672">}</span> <span style="color:#f92672">]</span> <span style="color:#f92672">}</span>
</code></pre></div><p>之后yrq又看了一本书，再次添加:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">&gt; db.foo.update<span style="color:#f92672">({</span><span style="color:#e6db74">&#34;user&#34;</span>:<span style="color:#e6db74">&#34;yrq&#34;</span><span style="color:#f92672">}</span>,<span style="color:#f92672">{</span><span style="color:#e6db74">&#34;</span>$push<span style="color:#e6db74">&#34;</span>:<span style="color:#f92672">{</span><span style="color:#e6db74">&#34;books&#34;</span>:<span style="color:#f92672">{</span><span style="color:#e6db74">&#34;book&#34;</span>:<span style="color:#e6db74">&#34;Know Mongo&#34;</span>,<span style="color:#e6db74">&#34;author&#34;</span>:<span style="color:#e6db74">&#34;bbb&#34;</span><span style="color:#f92672">}}})</span>
WriteResult<span style="color:#f92672">({</span> <span style="color:#e6db74">&#34;nMatched&#34;</span> : 1, <span style="color:#e6db74">&#34;nUpserted&#34;</span> : 0, <span style="color:#e6db74">&#34;nModified&#34;</span> : <span style="color:#ae81ff">1</span> <span style="color:#f92672">})</span>
&gt; db.foo.find<span style="color:#f92672">()</span>
<span style="color:#f92672">{</span> <span style="color:#e6db74">&#34;_id&#34;</span> : ObjectId<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;58e1be6cb6647fe45f462cf2&#34;</span><span style="color:#f92672">)</span>, <span style="color:#e6db74">&#34;content&#34;</span> : <span style="color:#e6db74">&#34;Hello&#34;</span>, <span style="color:#e6db74">&#34;user&#34;</span> : <span style="color:#e6db74">&#34;yrq&#34;</span>, <span style="color:#e6db74">&#34;books&#34;</span> : <span style="color:#f92672">[</span> <span style="color:#f92672">{</span> <span style="color:#e6db74">&#34;book&#34;</span> : <span style="color:#e6db74">&#34;Know JS&#34;</span>, <span style="color:#e6db74">&#34;author&#34;</span> : <span style="color:#e6db74">&#34;aaa&#34;</span> <span style="color:#f92672">}</span>, <span style="color:#f92672">{</span> <span style="color:#e6db74">&#34;book&#34;</span> : <span style="color:#e6db74">&#34;Know Mongo&#34;</span>, <span style="color:#e6db74">&#34;author&#34;</span> : <span style="color:#e6db74">&#34;bbb&#34;</span> <span style="color:#f92672">}</span> <span style="color:#f92672">]</span> <span style="color:#f92672">}</span>
</code></pre></div></li>
</ol>
<h4 id="upsert">upsert</h4>
<p>一种特殊的更新，若未找到符合条件的文档就会以更新条件和更新文档为基础创建新的文档，若找到了则正常更新。</p>
<p>通过将update的第三个参数设为true来使用upsert</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">&gt; db.foo.update<span style="color:#f92672">({</span><span style="color:#e6db74">&#34;user&#34;</span>:<span style="color:#e6db74">&#34;yrq&#34;</span><span style="color:#f92672">}</span>,<span style="color:#f92672">{</span><span style="color:#e6db74">&#34;</span>$inc<span style="color:#e6db74">&#34;</span>:<span style="color:#f92672">{</span><span style="color:#e6db74">&#34;score&#34;</span>:500<span style="color:#f92672">}}</span>,true<span style="color:#f92672">)</span>
WriteResult<span style="color:#f92672">({</span> <span style="color:#e6db74">&#34;nMatched&#34;</span> : 1, <span style="color:#e6db74">&#34;nUpserted&#34;</span> : 0, <span style="color:#e6db74">&#34;nModified&#34;</span> : <span style="color:#ae81ff">1</span> <span style="color:#f92672">})</span>
&gt; db.foo.find<span style="color:#f92672">()</span>
<span style="color:#f92672">{</span> <span style="color:#e6db74">&#34;_id&#34;</span> : ObjectId<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;58e1be6cb6647fe45f462cf2&#34;</span><span style="color:#f92672">)</span>, <span style="color:#e6db74">&#34;content&#34;</span> : <span style="color:#e6db74">&#34;Hello&#34;</span>, <span style="color:#e6db74">&#34;user&#34;</span> : <span style="color:#e6db74">&#34;yrq&#34;</span>, <span style="color:#e6db74">&#34;score&#34;</span> : <span style="color:#ae81ff">500</span> <span style="color:#f92672">}</span>
</code></pre></div><p>虽然效果与之前的一样，但upsert是原子性的，更高效。</p>
<h3 id="查询">查询</h3>
<h4 id="find和findone查询">find和findOne查询</h4>
<p>使用find和findOne方法，前者返回符合条件的文档，后者返回符合条件的第一条文档。</p>
<ol>
<li>
<p>find中的第一个参数决定返回哪些文档,{}为匹配所有文档</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">&gt; db.foo.find<span style="color:#f92672">({</span><span style="color:#e6db74">&#34;content&#34;</span> : <span style="color:#e6db74">&#34;Hello mongo&#34;</span><span style="color:#f92672">})</span>
<span style="color:#f92672">{</span> <span style="color:#e6db74">&#34;_id&#34;</span> : ObjectId<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;58e1be6cb6647fe45f462cf2&#34;</span><span style="color:#f92672">)</span>, <span style="color:#e6db74">&#34;content&#34;</span> : <span style="color:#e6db74">&#34;Hello mongo&#34;</span> <span style="color:#f92672">}</span>
</code></pre></div></li>
<li>
<p>find中的第二个参数指定需要返回的键</p>
</li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">&gt; db.foo.find<span style="color:#f92672">({}</span>,<span style="color:#f92672">{</span>_id:1<span style="color:#f92672">})</span>
<span style="color:#f92672">{</span> <span style="color:#e6db74">&#34;_id&#34;</span> : ObjectId<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;58e1be6cb6647fe45f462cf2&#34;</span><span style="color:#f92672">)</span> <span style="color:#f92672">}</span>
</code></pre></div><h4 id="查询条件">查询条件</h4>
<p>首先插入一些用户数据:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">&gt; db.users.find<span style="color:#f92672">()</span>
<span style="color:#f92672">{</span> <span style="color:#e6db74">&#34;_id&#34;</span> : ObjectId<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;58e2420bb6647fe45f462cf6&#34;</span><span style="color:#f92672">)</span>, <span style="color:#e6db74">&#34;name&#34;</span> : <span style="color:#e6db74">&#34;yrq&#34;</span>, <span style="color:#e6db74">&#34;age&#34;</span> : 30, <span style="color:#e6db74">&#34;email&#34;</span> : <span style="color:#e6db74">&#34;yrq@163.com&#34;</span> <span style="color:#f92672">}</span>
<span style="color:#f92672">{</span> <span style="color:#e6db74">&#34;_id&#34;</span> : ObjectId<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;58e24213b6647fe45f462cf7&#34;</span><span style="color:#f92672">)</span>, <span style="color:#e6db74">&#34;name&#34;</span> : <span style="color:#e6db74">&#34;yy&#34;</span>, <span style="color:#e6db74">&#34;age&#34;</span> : 25, <span style="color:#e6db74">&#34;email&#34;</span> : <span style="color:#e6db74">&#34;yy@163.com&#34;</span> <span style="color:#f92672">}</span>
<span style="color:#f92672">{</span> <span style="color:#e6db74">&#34;_id&#34;</span> : ObjectId<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;58e2421fb6647fe45f462cf8&#34;</span><span style="color:#f92672">)</span>, <span style="color:#e6db74">&#34;name&#34;</span> : <span style="color:#e6db74">&#34;dxy&#34;</span>, <span style="color:#e6db74">&#34;age&#34;</span> : 22, <span style="color:#e6db74">&#34;email&#34;</span> : <span style="color:#e6db74">&#34;dxy@163.com&#34;</span> <span style="color:#f92672">}</span>
</code></pre></div><ol>
<li>
<p>条件查询</p>
<p>&ldquo;$lt&rdquo;、&ldquo;$lte&rdquo;、&ldquo;$gt&rdquo;、&ldquo;$gte&quot;对应&lt;、&lt;=、&gt;、&gt;=，可组合起来查询范围内的值。
查找在23~26岁（含）之间的用户信息:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">&gt; db.users.find<span style="color:#f92672">({</span><span style="color:#e6db74">&#34;age&#34;</span>:<span style="color:#f92672">{</span><span style="color:#e6db74">&#34;</span>$gt<span style="color:#e6db74">&#34;</span>:23,<span style="color:#e6db74">&#34;</span>$lte<span style="color:#e6db74">&#34;</span>:26<span style="color:#f92672">}})</span>
<span style="color:#f92672">{</span> <span style="color:#e6db74">&#34;_id&#34;</span> : ObjectId<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;58e24213b6647fe45f462cf7&#34;</span><span style="color:#f92672">)</span>, <span style="color:#e6db74">&#34;name&#34;</span> : <span style="color:#e6db74">&#34;yy&#34;</span>, <span style="color:#e6db74">&#34;age&#34;</span> : 25, <span style="color:#e6db74">&#34;email&#34;</span> : <span style="color:#e6db74">&#34;yy@163.com&#34;</span> <span style="color:#f92672">}</span>  
</code></pre></div><p>也可使用另外一种操作符&quot;$ne&rdquo;，表示不相等:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">&gt; db.users.find<span style="color:#f92672">({</span><span style="color:#e6db74">&#34;age&#34;</span>:<span style="color:#f92672">{</span><span style="color:#e6db74">&#34;</span>$ne<span style="color:#e6db74">&#34;</span>:25<span style="color:#f92672">}})</span>
<span style="color:#f92672">{</span> <span style="color:#e6db74">&#34;_id&#34;</span> : ObjectId<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;58e2420bb6647fe45f462cf6&#34;</span><span style="color:#f92672">)</span>, <span style="color:#e6db74">&#34;name&#34;</span> : <span style="color:#e6db74">&#34;yrq&#34;</span>, <span style="color:#e6db74">&#34;age&#34;</span> : 30, <span style="color:#e6db74">&#34;email&#34;</span> : <span style="color:#e6db74">&#34;yrq@163.com&#34;</span> <span style="color:#f92672">}</span>
<span style="color:#f92672">{</span> <span style="color:#e6db74">&#34;_id&#34;</span> : ObjectId<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;58e2421fb6647fe45f462cf8&#34;</span><span style="color:#f92672">)</span>, <span style="color:#e6db74">&#34;name&#34;</span> : <span style="color:#e6db74">&#34;dxy&#34;</span>, <span style="color:#e6db74">&#34;age&#34;</span> : 22, <span style="color:#e6db74">&#34;email&#34;</span> : <span style="color:#e6db74">&#34;dxy@163.com&#34;</span> <span style="color:#f92672">}</span>
</code></pre></div></li>
<li>
<p>OR查询</p>
<p>&ldquo;$in&quot;用来查询查询一个键的多个值，比如查询所有年龄为22和25岁的用户信息:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">&gt; db.users.find<span style="color:#f92672">({</span><span style="color:#e6db74">&#34;age&#34;</span>:<span style="color:#f92672">{</span><span style="color:#e6db74">&#34;</span>$in<span style="color:#e6db74">&#34;</span>:<span style="color:#f92672">[</span>22,25<span style="color:#f92672">]}})</span>
<span style="color:#f92672">{</span> <span style="color:#e6db74">&#34;_id&#34;</span> : ObjectId<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;58e24213b6647fe45f462cf7&#34;</span><span style="color:#f92672">)</span>, <span style="color:#e6db74">&#34;name&#34;</span> : <span style="color:#e6db74">&#34;yy&#34;</span>, <span style="color:#e6db74">&#34;age&#34;</span> : 25, <span style="color:#e6db74">&#34;email&#34;</span> : <span style="color:#e6db74">&#34;yy@163.com&#34;</span> <span style="color:#f92672">}</span>
<span style="color:#f92672">{</span> <span style="color:#e6db74">&#34;_id&#34;</span> : ObjectId<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;58e2421fb6647fe45f462cf8&#34;</span><span style="color:#f92672">)</span>, <span style="color:#e6db74">&#34;name&#34;</span> : <span style="color:#e6db74">&#34;dxy&#34;</span>, <span style="color:#e6db74">&#34;age&#34;</span> : 22, <span style="color:#e6db74">&#34;email&#34;</span> : <span style="color:#e6db74">&#34;dxy@163.com&#34;</span> <span style="color:#f92672">}</span>
</code></pre></div><p>“$in”中可以指定不同类型的值。</p>
<p>&ldquo;$or&quot;更通用一些，可以在多个键中查询任意的给定值,比如查询名称为yy或年龄为22的用户信息:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">&gt; db.users.find<span style="color:#f92672">({</span><span style="color:#e6db74">&#34;</span>$or<span style="color:#e6db74">&#34;</span>:<span style="color:#f92672">[{</span><span style="color:#e6db74">&#34;name&#34;</span>:<span style="color:#e6db74">&#34;yy&#34;</span><span style="color:#f92672">}</span>,<span style="color:#f92672">{</span><span style="color:#e6db74">&#34;age&#34;</span>:22<span style="color:#f92672">}]})</span>
<span style="color:#f92672">{</span> <span style="color:#e6db74">&#34;_id&#34;</span> : ObjectId<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;58e24213b6647fe45f462cf7&#34;</span><span style="color:#f92672">)</span>, <span style="color:#e6db74">&#34;name&#34;</span> : <span style="color:#e6db74">&#34;yy&#34;</span>, <span style="color:#e6db74">&#34;age&#34;</span> : 25, <span style="color:#e6db74">&#34;email&#34;</span> : <span style="color:#e6db74">&#34;yy@163.com&#34;</span> <span style="color:#f92672">}</span>
<span style="color:#f92672">{</span> <span style="color:#e6db74">&#34;_id&#34;</span> : ObjectId<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;58e2421fb6647fe45f462cf8&#34;</span><span style="color:#f92672">)</span>, <span style="color:#e6db74">&#34;name&#34;</span> : <span style="color:#e6db74">&#34;dxy&#34;</span>, <span style="color:#e6db74">&#34;age&#34;</span> : 22, <span style="color:#e6db74">&#34;email&#34;</span> : <span style="color:#e6db74">&#34;dxy@163.com&#34;</span> <span style="color:#f92672">}</span>
</code></pre></div></li>
<li>
<p>$not</p>
<p>&ldquo;$not&quot;是元条件句，可以用在任何其他条件之上，比如查询除了年龄22和25岁的用户信息:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">&gt; db.users.find<span style="color:#f92672">({</span><span style="color:#e6db74">&#34;age&#34;</span>:<span style="color:#f92672">{</span><span style="color:#e6db74">&#34;</span>$not<span style="color:#e6db74">&#34;</span>:<span style="color:#f92672">{</span><span style="color:#e6db74">&#34;</span>$in<span style="color:#e6db74">&#34;</span>:<span style="color:#f92672">[</span>22,25<span style="color:#f92672">]}}})</span>
<span style="color:#f92672">{</span> <span style="color:#e6db74">&#34;_id&#34;</span> : ObjectId<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;58e2420bb6647fe45f462cf6&#34;</span><span style="color:#f92672">)</span>, <span style="color:#e6db74">&#34;name&#34;</span> : <span style="color:#e6db74">&#34;yrq&#34;</span>, <span style="color:#e6db74">&#34;age&#34;</span> : 30, <span style="color:#e6db74">&#34;email&#34;</span> : <span style="color:#e6db74">&#34;yrq@163.com&#34;</span> <span style="color:#f92672">}</span>
</code></pre></div></li>
</ol>
<h4 id="特定类型查询">特定类型查询</h4>
<ol>
<li>
<p>null</p>
<p>若仅想匹配值为null的文档，既要检查是否为null也要使用&quot;$exists&quot;条件判定键值已存在:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">&gt; db.users.find<span style="color:#f92672">({</span><span style="color:#e6db74">&#34;y&#34;</span>:<span style="color:#f92672">{</span><span style="color:#e6db74">&#34;</span>$in<span style="color:#e6db74">&#34;</span>:<span style="color:#f92672">[</span>null<span style="color:#f92672">]</span>,<span style="color:#e6db74">&#34;</span>$exists<span style="color:#e6db74">&#34;</span>:true<span style="color:#f92672">}})</span>
<span style="color:#f92672">{</span> <span style="color:#e6db74">&#34;_id&#34;</span> : ObjectId<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;58e2420bb6647fe45f462cf6&#34;</span><span style="color:#f92672">)</span>, <span style="color:#e6db74">&#34;name&#34;</span> : <span style="color:#e6db74">&#34;yrq&#34;</span>, <span style="color:#e6db74">&#34;age&#34;</span> : 30, <span style="color:#e6db74">&#34;email&#34;</span> : <span style="color:#e6db74">&#34;yrq@163.com&#34;</span>, <span style="color:#e6db74">&#34;y&#34;</span> : null <span style="color:#f92672">}</span>
</code></pre></div></li>
<li>
<p>正则</p>
<p>比如寻找名称中含有字符r的用户信息，不区分大小写:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">&gt; db.users.find<span style="color:#f92672">({</span><span style="color:#e6db74">&#34;name&#34;</span>:/r/i<span style="color:#f92672">})</span>
<span style="color:#f92672">{</span> <span style="color:#e6db74">&#34;_id&#34;</span> : ObjectId<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;58e2420bb6647fe45f462cf6&#34;</span><span style="color:#f92672">)</span>, <span style="color:#e6db74">&#34;name&#34;</span> : <span style="color:#e6db74">&#34;yrq&#34;</span>, <span style="color:#e6db74">&#34;age&#34;</span> : 30, <span style="color:#e6db74">&#34;email&#34;</span> : <span style="color:#e6db74">&#34;yrq@163.com&#34;</span>, <span style="color:#e6db74">&#34;y&#34;</span> : null <span style="color:#f92672">}</span>
</code></pre></div></li>
<li>
<p>数组</p>
</li>
</ol>
<h3 id="游标">游标</h3>
<p>通过游标返回find的查询结果，调整游标的行为可以控制输出的最终结果。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># 1.构造查询</span>
&gt; var cursor <span style="color:#f92672">=</span> db.users.find<span style="color:#f92672">()</span>
<span style="color:#75715e"># 2.发送查询，shell得到查询结果，结果中是否还有数据未被返回</span>
&gt; cursor.hasNext<span style="color:#f92672">()</span>
true
<span style="color:#75715e"># 3.获得结果中的下一条数据</span>
&gt; cursor.next<span style="color:#f92672">()</span>
<span style="color:#f92672">{</span>
	<span style="color:#e6db74">&#34;_id&#34;</span> : ObjectId<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;58e2420bb6647fe45f462cf6&#34;</span><span style="color:#f92672">)</span>,
	<span style="color:#e6db74">&#34;name&#34;</span> : <span style="color:#e6db74">&#34;yrq&#34;</span>,
	<span style="color:#e6db74">&#34;age&#34;</span> : 18,
	<span style="color:#e6db74">&#34;email&#34;</span> : <span style="color:#e6db74">&#34;yrq@163.com&#34;</span>,
	<span style="color:#e6db74">&#34;y&#34;</span> : null,
	<span style="color:#e6db74">&#34;sex&#34;</span> : <span style="color:#e6db74">&#34;male&#34;</span>
<span style="color:#f92672">}</span>
<span style="color:#75715e"># 4.直接读取，由于第一条数据已返回显示的是后两条数据</span>
&gt; cursor
<span style="color:#f92672">{</span> <span style="color:#e6db74">&#34;_id&#34;</span> : ObjectId<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;58e24213b6647fe45f462cf7&#34;</span><span style="color:#f92672">)</span>, <span style="color:#e6db74">&#34;name&#34;</span> : <span style="color:#e6db74">&#34;yy&#34;</span>, <span style="color:#e6db74">&#34;age&#34;</span> : 25, <span style="color:#e6db74">&#34;email&#34;</span> : <span style="color:#e6db74">&#34;yy@163.com&#34;</span> <span style="color:#f92672">}</span>
<span style="color:#f92672">{</span> <span style="color:#e6db74">&#34;_id&#34;</span> : ObjectId<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;58e2421fb6647fe45f462cf8&#34;</span><span style="color:#f92672">)</span>, <span style="color:#e6db74">&#34;name&#34;</span> : <span style="color:#e6db74">&#34;dxy&#34;</span>, <span style="color:#e6db74">&#34;age&#34;</span> : 22, <span style="color:#e6db74">&#34;email&#34;</span> : <span style="color:#e6db74">&#34;dxy@163.com&#34;</span> <span style="color:#f92672">}</span>
<span style="color:#75715e"># 5.再次读取就为空了，这是由于所有结果都已返回，游标被释放掉了（默认情况下，10分钟不使用游标也会被释放）</span>
&gt; cursor
&gt;
</code></pre></div><h4 id="查询选项相关函数">查询选项相关函数</h4>
<ol>
<li>
<p>limit - 限制返回结果数量，参数为数量上限</p>
<p>比如最多返回两条用户数据:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">&gt; db.users.find<span style="color:#f92672">()</span>.limit<span style="color:#f92672">(</span>2<span style="color:#f92672">)</span>
<span style="color:#f92672">{</span> <span style="color:#e6db74">&#34;_id&#34;</span> : ObjectId<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;58e2420bb6647fe45f462cf6&#34;</span><span style="color:#f92672">)</span>, <span style="color:#e6db74">&#34;name&#34;</span> : <span style="color:#e6db74">&#34;yrq&#34;</span>, <span style="color:#e6db74">&#34;age&#34;</span> : 18, <span style="color:#e6db74">&#34;email&#34;</span> : <span style="color:#e6db74">&#34;yrq@163.com&#34;</span>, <span style="color:#e6db74">&#34;y&#34;</span> : null, <span style="color:#e6db74">&#34;sex&#34;</span> : <span style="color:#e6db74">&#34;male&#34;</span> <span style="color:#f92672">}</span>
<span style="color:#f92672">{</span> <span style="color:#e6db74">&#34;_id&#34;</span> : ObjectId<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;58e24213b6647fe45f462cf7&#34;</span><span style="color:#f92672">)</span>, <span style="color:#e6db74">&#34;name&#34;</span> : <span style="color:#e6db74">&#34;yy&#34;</span>, <span style="color:#e6db74">&#34;age&#34;</span> : 25, <span style="color:#e6db74">&#34;email&#34;</span> : <span style="color:#e6db74">&#34;yy@163.com&#34;</span> <span style="color:#f92672">}</span>
</code></pre></div></li>
<li>
<p>skip - 跳过指定数量的数据</p>
<p>比如跳过前两条用户数据:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">&gt; db.users.find<span style="color:#f92672">()</span>.skip<span style="color:#f92672">(</span>2<span style="color:#f92672">)</span>
<span style="color:#f92672">{</span> <span style="color:#e6db74">&#34;_id&#34;</span> : ObjectId<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;58e2421fb6647fe45f462cf8&#34;</span><span style="color:#f92672">)</span>, <span style="color:#e6db74">&#34;name&#34;</span> : <span style="color:#e6db74">&#34;dxy&#34;</span>, <span style="color:#e6db74">&#34;age&#34;</span> : 22, <span style="color:#e6db74">&#34;email&#34;</span> : <span style="color:#e6db74">&#34;dxy@163.com&#34;</span> <span style="color:#f92672">}</span>
</code></pre></div></li>
<li>
<p>sort - 对数据进行排序</p>
<p>比如按照年龄的正序对用户数据进行排序:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">&gt; db.users.find<span style="color:#f92672">()</span>.sort<span style="color:#f92672">({</span><span style="color:#e6db74">&#34;age&#34;</span>:1<span style="color:#f92672">})</span>
<span style="color:#f92672">{</span> <span style="color:#e6db74">&#34;_id&#34;</span> : ObjectId<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;58e2420bb6647fe45f462cf6&#34;</span><span style="color:#f92672">)</span>, <span style="color:#e6db74">&#34;name&#34;</span> : <span style="color:#e6db74">&#34;yrq&#34;</span>, <span style="color:#e6db74">&#34;age&#34;</span> : 18, <span style="color:#e6db74">&#34;email&#34;</span> : <span style="color:#e6db74">&#34;yrq@163.com&#34;</span>, <span style="color:#e6db74">&#34;y&#34;</span> : null, <span style="color:#e6db74">&#34;sex&#34;</span> : <span style="color:#e6db74">&#34;male&#34;</span> <span style="color:#f92672">}</span>
<span style="color:#f92672">{</span> <span style="color:#e6db74">&#34;_id&#34;</span> : ObjectId<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;58e2421fb6647fe45f462cf8&#34;</span><span style="color:#f92672">)</span>, <span style="color:#e6db74">&#34;name&#34;</span> : <span style="color:#e6db74">&#34;dxy&#34;</span>, <span style="color:#e6db74">&#34;age&#34;</span> : 22, <span style="color:#e6db74">&#34;email&#34;</span> : <span style="color:#e6db74">&#34;dxy@163.com&#34;</span> <span style="color:#f92672">}</span>
<span style="color:#f92672">{</span> <span style="color:#e6db74">&#34;_id&#34;</span> : ObjectId<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;58e24213b6647fe45f462cf7&#34;</span><span style="color:#f92672">)</span>, <span style="color:#e6db74">&#34;name&#34;</span> : <span style="color:#e6db74">&#34;yy&#34;</span>, <span style="color:#e6db74">&#34;age&#34;</span> : 25, <span style="color:#e6db74">&#34;email&#34;</span> : <span style="color:#e6db74">&#34;yy@163.com&#34;</span> <span style="color:#f92672">}</span>
</code></pre></div></li>
</ol>
<h2 id="索引">索引</h2>
<p>索引，相当于一本字典的目录，用于加快查询速度。在查询时，若存在索引会先在索引中查找，找到后直接跳到目标文档的位置，可以使查询速度提高几个数量级。</p>
<h3 id="使用">使用</h3>
<ol>
<li>
<p>先清空一下之前的users集合</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">&gt; db.users.remove<span style="color:#f92672">({})</span>
</code></pre></div></li>
<li>
<p>加入10万条随机的用户数据</p>
</li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">&gt; <span style="color:#66d9ef">for</span><span style="color:#f92672">(</span>var i<span style="color:#f92672">=</span>0;i&lt;100000;i++<span style="color:#f92672">){</span>
...   db.users.insert<span style="color:#f92672">(</span>
...     <span style="color:#f92672">{</span>
...       <span style="color:#e6db74">&#34;number&#34;</span>:i,
...       <span style="color:#e6db74">&#34;user&#34;</span>:<span style="color:#e6db74">&#34;user_&#34;</span>+i,
...       <span style="color:#e6db74">&#34;age&#34;</span>:Math.floor<span style="color:#f92672">(</span>Math.random<span style="color:#f92672">()</span>*120<span style="color:#f92672">)</span>,
...       <span style="color:#e6db74">&#34;created&#34;</span>: new Date<span style="color:#f92672">()</span>
...     <span style="color:#f92672">}</span>
...   <span style="color:#f92672">)</span>;
... <span style="color:#f92672">}</span>
</code></pre></div><ol start="3">
<li>
<p>查询用户名为user_10000的用户数据，使用explain方法可以看到整个查询过程搜索了所有10万个文档，耗时61ms</p>
<p>新版的explain方法默认为queryPlanner模式，需要输入executionStats键来查看具体的查询信息。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">&gt; db.users.find<span style="color:#f92672">({</span><span style="color:#e6db74">&#34;user&#34;</span>:<span style="color:#e6db74">&#34;user_10000&#34;</span><span style="color:#f92672">})</span>.explain<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;executionStats&#34;</span><span style="color:#f92672">)</span>.executionStats
<span style="color:#f92672">{</span>
  <span style="color:#e6db74">&#34;executionSuccess&#34;</span> : true,
  <span style="color:#e6db74">&#34;nReturned&#34;</span> : 1,
  <span style="color:#e6db74">&#34;executionTimeMillis&#34;</span> : 61,
  <span style="color:#e6db74">&#34;totalKeysExamined&#34;</span> : 0,
  <span style="color:#e6db74">&#34;totalDocsExamined&#34;</span> : 100000,
  <span style="color:#e6db74">&#34;executionStages&#34;</span> : <span style="color:#f92672">{</span>
    <span style="color:#e6db74">&#34;stage&#34;</span> : <span style="color:#e6db74">&#34;COLLSCAN&#34;</span>,
    <span style="color:#e6db74">&#34;filter&#34;</span> : <span style="color:#f92672">{</span>
      <span style="color:#e6db74">&#34;user&#34;</span> : <span style="color:#f92672">{</span>
        <span style="color:#e6db74">&#34;</span>$eq<span style="color:#e6db74">&#34;</span> : <span style="color:#e6db74">&#34;user_10000&#34;</span>
      <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>,
    <span style="color:#e6db74">&#34;nReturned&#34;</span> : 1,
    <span style="color:#e6db74">&#34;executionTimeMillisEstimate&#34;</span> : 59,
    <span style="color:#e6db74">&#34;works&#34;</span> : 100002,
    <span style="color:#e6db74">&#34;advanced&#34;</span> : 1,
    <span style="color:#e6db74">&#34;needTime&#34;</span> : 100000,
    <span style="color:#e6db74">&#34;needYield&#34;</span> : 0,
    <span style="color:#e6db74">&#34;saveState&#34;</span> : 783,
    <span style="color:#e6db74">&#34;restoreState&#34;</span> : 783,
    <span style="color:#e6db74">&#34;isEOF&#34;</span> : 1,
    <span style="color:#e6db74">&#34;invalidates&#34;</span> : 0,
    <span style="color:#e6db74">&#34;direction&#34;</span> : <span style="color:#e6db74">&#34;forward&#34;</span>,
    <span style="color:#e6db74">&#34;docsExamined&#34;</span> : <span style="color:#ae81ff">100000</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div></li>
<li>
<p>添加user键的索引(升序)</p>
</li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">&gt; db.users.ensureIndex<span style="color:#f92672">({</span><span style="color:#e6db74">&#34;user&#34;</span>:1<span style="color:#f92672">})</span>
</code></pre></div><ol start="5">
<li>再次进行查询，可以看到仅搜索了一个文档直接找到了，耗时7ms</li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">&gt; db.users.find<span style="color:#f92672">({</span>user:<span style="color:#e6db74">&#34;user_10000&#34;</span><span style="color:#f92672">})</span>.explain<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;executionStats&#34;</span><span style="color:#f92672">)</span>.executionStats
<span style="color:#f92672">{</span>
  <span style="color:#e6db74">&#34;executionSuccess&#34;</span> : true,
  <span style="color:#e6db74">&#34;nReturned&#34;</span> : 1,
  <span style="color:#e6db74">&#34;executionTimeMillis&#34;</span> : 7,
  <span style="color:#e6db74">&#34;totalKeysExamined&#34;</span> : 1,
  <span style="color:#e6db74">&#34;totalDocsExamined&#34;</span> : 1,
  <span style="color:#e6db74">&#34;executionStages&#34;</span> : <span style="color:#f92672">{</span>
      <span style="color:#e6db74">&#34;stage&#34;</span> : <span style="color:#e6db74">&#34;FETCH&#34;</span>,
      <span style="color:#e6db74">&#34;nReturned&#34;</span> : 1,
      <span style="color:#e6db74">&#34;executionTimeMillisEstimate&#34;</span> : 0,
      <span style="color:#e6db74">&#34;works&#34;</span> : 2,
      <span style="color:#e6db74">&#34;advanced&#34;</span> : 1,
      <span style="color:#e6db74">&#34;needTime&#34;</span> : 0,
      <span style="color:#e6db74">&#34;needYield&#34;</span> : 0,
      <span style="color:#e6db74">&#34;saveState&#34;</span> : 0,
      <span style="color:#e6db74">&#34;restoreState&#34;</span> : 0,
      <span style="color:#e6db74">&#34;isEOF&#34;</span> : 1,
      <span style="color:#e6db74">&#34;invalidates&#34;</span> : 0,
      <span style="color:#e6db74">&#34;docsExamined&#34;</span> : 1,
      <span style="color:#e6db74">&#34;alreadyHasObj&#34;</span> : 0,
      ...
      <span style="color:#f92672">}</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><h3 id="复合索引">复合索引</h3>
<p>在需要进行多值查询与排序时，可以使用复合索引，不同索引的使用方式取决于查询的类型。</p>
<h4 id="键的方向">键的方向</h4>
<p>若需要在多个查询条件上进行排序，可能在索引键的方向上会不同。</p>
<ul>
<li>索引<code>{&quot;user&quot; : 1, &quot;age&quot; : 1}</code>和索引<code>{&quot;user&quot; : 1, &quot;age&quot; : -1}</code>是不同的。</li>
<li>索引<code>{&quot;user&quot; : 1, &quot;age&quot; : -1}</code>和索引<code>{&quot;user&quot; : -1, &quot;age&quot; : 1}</code>是等价的。</li>
</ul>
<h4 id="隐式索引">隐式索引</h4>
<p>如果有一个拥有N个键的索引，那么就同时拥有了所有这N个键的前缀组成的索引。</p>
<p>比如你有了一个索引<code>{&quot;age&quot; : 1, &quot;created&quot; : 1, &quot;user&quot; : 1}</code>，就相当于也有了一个索引<code>{&quot;age&quot; : 1}</code>和一个索引<code>{&quot;age&quot; : 1, &quot;created&quot; : 1}</code>。</p>
<h3 id="管理">管理</h3>
<h4 id="查看">查看</h4>
<p>在集合上使用getIndexes()方法查看所有索引信息。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">&gt; db.users.getIndexes<span style="color:#f92672">()</span>
<span style="color:#f92672">[</span>
	<span style="color:#f92672">{</span>
		<span style="color:#e6db74">&#34;v&#34;</span> : 2,
		<span style="color:#e6db74">&#34;key&#34;</span> : <span style="color:#f92672">{</span>
			<span style="color:#e6db74">&#34;_id&#34;</span> : <span style="color:#ae81ff">1</span>
		<span style="color:#f92672">}</span>,
		<span style="color:#e6db74">&#34;name&#34;</span> : <span style="color:#e6db74">&#34;_id_&#34;</span>,
		<span style="color:#e6db74">&#34;ns&#34;</span> : <span style="color:#e6db74">&#34;test.users&#34;</span>
	<span style="color:#f92672">}</span>,
	<span style="color:#f92672">{</span>
		<span style="color:#e6db74">&#34;v&#34;</span> : 2,
		<span style="color:#e6db74">&#34;key&#34;</span> : <span style="color:#f92672">{</span>
			<span style="color:#e6db74">&#34;user&#34;</span> : <span style="color:#ae81ff">1</span>
		<span style="color:#f92672">}</span>,
		<span style="color:#e6db74">&#34;name&#34;</span> : <span style="color:#e6db74">&#34;user_1&#34;</span>,
		<span style="color:#e6db74">&#34;ns&#34;</span> : <span style="color:#e6db74">&#34;test.users&#34;</span>
	<span style="color:#f92672">}</span>
<span style="color:#f92672">]</span>
</code></pre></div><p>其中_id索引为自动创建的，user为之前创建的索引。v标识索引版本，key和name为具体的键名称方向信息与索引的标识信息。</p>
<h4 id="标识">标识</h4>
<p>索引信息中的name字段为索引的标识，生成规则为&quot;键_方向_键_方向&hellip;&quot;，如升序user索引的name为&quot;user_1&rdquo;，也可以在生成索引时指定索引名称。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">&gt; db.users.ensureIndex<span style="color:#f92672">({</span><span style="color:#e6db74">&#34;user&#34;</span>:1<span style="color:#f92672">}</span>,<span style="color:#f92672">{</span><span style="color:#e6db74">&#34;name&#34;</span>:<span style="color:#e6db74">&#34;u&#34;</span><span style="color:#f92672">})</span>
</code></pre></div><h4 id="删除-1">删除</h4>
<p>使用dropIndex()方法删除索引，用索引信息中的name字段指定所删索引。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">&gt; db.users.dropIndex<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;user_1&#34;</span><span style="color:#f92672">)</span>
</code></pre></div><h3 id="特殊集合和索引">特殊集合和索引</h3>
<h4 id="视图">视图</h4>
<p>3.4版本中的新特性</p>
<p>可以根据已存在的集合创建只读视图(read-only views)。</p>
<ol>
<li>
<p>创建</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">&gt; db.createView<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;yrq_view&#34;</span>,<span style="color:#e6db74">&#34;comments&#34;</span>,<span style="color:#f92672">{</span>$match:<span style="color:#f92672">{</span><span style="color:#e6db74">&#34;name&#34;</span>:<span style="color:#e6db74">&#34;yrq&#34;</span><span style="color:#f92672">}})</span>
<span style="color:#f92672">{</span> <span style="color:#e6db74">&#34;ok&#34;</span> : <span style="color:#ae81ff">1</span> <span style="color:#f92672">}</span>
&gt; show collections
comments
yrq_view
</code></pre></div><p>可以看到视图是一种集合。输入参数分别为视图名、集合、管道操作。</p>
</li>
<li>
<p>特性</p>
<ul>
<li>视图是只读的，尝试写入会发生错误</li>
<li>可以使用源集合中的索引</li>
<li>不能对视图重命名</li>
<li>不支持集合上的mapReduce操作、$text操作符、geoNear命令</li>
</ul>
</li>
</ol>
<h4 id="固定集合">固定集合</h4>
<p>顾名思义，固定集合就是固定大小的集合，存储方式类似一个循环队列，当容量满时插入新数据会将老数据删除。</p>
<ol>
<li>
<p>创建一个指定大小的固定集合</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">&gt; db.createCollection<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;capped_collection&#34;</span>,<span style="color:#f92672">{</span><span style="color:#e6db74">&#34;capped&#34;</span>:true,<span style="color:#e6db74">&#34;size&#34;</span>:10000<span style="color:#f92672">})</span>
<span style="color:#f92672">{</span> <span style="color:#e6db74">&#34;ok&#34;</span> : <span style="color:#ae81ff">1</span> <span style="color:#f92672">}</span>
</code></pre></div></li>
<li>
<p>指定最大文档数量，无论先达到大小限制还是数量限制，插入新文档后都会讲老文档挤出集合</p>
</li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">&gt; db.createCollection<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;capped_collection&#34;</span>,<span style="color:#f92672">{</span><span style="color:#e6db74">&#34;capped&#34;</span>:true,<span style="color:#e6db74">&#34;size&#34;</span>:10000，<span style="color:#e6db74">&#34;max&#34;</span>:100<span style="color:#f92672">})</span>
<span style="color:#f92672">{</span> <span style="color:#e6db74">&#34;ok&#34;</span> : <span style="color:#ae81ff">1</span> <span style="color:#f92672">}</span>
</code></pre></div><ol start="3">
<li>将已有的常规集合转换为固定集合，无法进行逆操作(将固定集合转换为非固定集合)</li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">&gt; db.runCommand<span style="color:#f92672">({</span><span style="color:#e6db74">&#34;convertToCapped&#34;</span>:<span style="color:#e6db74">&#34;users&#34;</span>,<span style="color:#e6db74">&#34;size&#34;</span>:100000<span style="color:#f92672">})</span>
<span style="color:#f92672">{</span> <span style="color:#e6db74">&#34;ok&#34;</span> : <span style="color:#ae81ff">1</span> <span style="color:#f92672">}</span>
</code></pre></div><h4 id="ttl索引">TTL索引</h4>
<p>TTL索引是一种具有生命周期的索引,Mongo每分钟会对TTL索引进行一次清理。</p>
<ol>
<li>
<p>创建一个保活一天的索引</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">&gt; db.users.ensureIndex<span style="color:#f92672">({</span><span style="color:#e6db74">&#34;created&#34;</span>:1<span style="color:#f92672">}</span>,<span style="color:#f92672">{</span><span style="color:#e6db74">&#34;expireAfterSeconds&#34;</span>:60*60*24<span style="color:#f92672">})</span>
<span style="color:#f92672">{</span>
  <span style="color:#e6db74">&#34;createdCollectionAutomatically&#34;</span> : false,
  <span style="color:#e6db74">&#34;numIndexesBefore&#34;</span> : 1,
  <span style="color:#e6db74">&#34;numIndexesAfter&#34;</span> : 2,
  <span style="color:#e6db74">&#34;ok&#34;</span> : <span style="color:#ae81ff">1</span>
<span style="color:#f92672">}</span>
</code></pre></div></li>
<li>
<p>使用collMod命令修改保活的时间</p>
</li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">&gt; db.runCommand<span style="color:#f92672">({</span><span style="color:#e6db74">&#34;collMod&#34;</span>:<span style="color:#e6db74">&#34;users&#34;</span>,index:<span style="color:#f92672">{</span>keyPattern : <span style="color:#f92672">{</span>created : 1<span style="color:#f92672">}</span>, expireAfterSeconds : 3600<span style="color:#f92672">}})</span>
<span style="color:#f92672">{</span>
  <span style="color:#e6db74">&#34;expireAfterSeconds_old&#34;</span> : 86400,
  <span style="color:#e6db74">&#34;expireAfterSeconds_new&#34;</span> : 3600,
  <span style="color:#e6db74">&#34;ok&#34;</span> : <span style="color:#ae81ff">1</span>
<span style="color:#f92672">}</span>
</code></pre></div><h4 id="全文索引">全文索引</h4>
<p>使用全文索引与$text操作符对字符串内容进行全文搜索操作。</p>
<ol>
<li>
<p>创建全文索引</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">&gt; db.users.ensureIndex<span style="color:#f92672">({</span><span style="color:#e6db74">&#34;user&#34;</span>:<span style="color:#e6db74">&#34;text&#34;</span><span style="color:#f92672">})</span>
<span style="color:#f92672">{</span>
  <span style="color:#e6db74">&#34;createdCollectionAutomatically&#34;</span> : false,
  <span style="color:#e6db74">&#34;numIndexesBefore&#34;</span> : 2,
  <span style="color:#e6db74">&#34;numIndexesAfter&#34;</span> : 3,
  <span style="color:#e6db74">&#34;ok&#34;</span> : <span style="color:#ae81ff">1</span>
<span style="color:#f92672">}</span>
</code></pre></div></li>
<li>
<p>通过$text操作符使用全文索引</p>
</li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">&gt; db.users.find<span style="color:#f92672">({</span>$text:<span style="color:#f92672">{</span>$search:<span style="color:#e6db74">&#34;user_98882&#34;</span><span style="color:#f92672">}})</span>
<span style="color:#f92672">{</span> <span style="color:#e6db74">&#34;_id&#34;</span> : ObjectId<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;58e6f4fd81ede7e9078b2fad&#34;</span><span style="color:#f92672">)</span>, <span style="color:#e6db74">&#34;number&#34;</span> : 98882, <span style="color:#e6db74">&#34;user&#34;</span> : <span style="color:#e6db74">&#34;user_98882&#34;</span>, <span style="color:#e6db74">&#34;age&#34;</span> : 96, <span style="color:#e6db74">&#34;created&#34;</span> : ISODate<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;2017-04-07T02:10:05.305Z&#34;</span><span style="color:#f92672">)</span> <span style="color:#f92672">}</span>
</code></pre></div><p>关于$text操作符，可以看看<a href="https://docs.mongodb.com/manual/reference/operator/query/text/">官方文档</a></p>
<h4 id="地理空间索引">地理空间索引</h4>
<p>MongoDB提供了两种地理空间索引，2d索引(平面地图)和2dsphere索引(曲面地图)。</p>
<p>具体内容可查看官方文档:<a href="https://docs.mongodb.com/manual/core/2d/#d-indexes">2d Indexes</a>和<a href="https://docs.mongodb.com/manual/core/2dsphere/">2dsphere Indexes</a></p>
<h2 id="聚合">聚合</h2>
<p>可以在集合上使用aggregate()对文档进行变换和组合操作，用多种构建构成一个管道(pipeline)。</p>
<p>假设要查找评论中评论次数最多的三名用户，可以使用如下聚合操作:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">&gt; db.comments.aggregate<span style="color:#f92672">(</span>
... <span style="color:#f92672">{</span><span style="color:#e6db74">&#34;</span>$project<span style="color:#e6db74">&#34;</span>:<span style="color:#f92672">{</span><span style="color:#e6db74">&#34;name&#34;</span>:1<span style="color:#f92672">}}</span>,
... <span style="color:#f92672">{</span><span style="color:#e6db74">&#34;</span>$group<span style="color:#e6db74">&#34;</span>:<span style="color:#f92672">{</span><span style="color:#e6db74">&#34;_id&#34;</span>:<span style="color:#e6db74">&#34;</span>$name<span style="color:#e6db74">&#34;</span>,<span style="color:#e6db74">&#34;count&#34;</span>:<span style="color:#f92672">{</span><span style="color:#e6db74">&#34;</span>$sum<span style="color:#e6db74">&#34;</span>:1<span style="color:#f92672">}}}</span>,
... <span style="color:#f92672">{</span><span style="color:#e6db74">&#34;</span>$sort<span style="color:#e6db74">&#34;</span>:<span style="color:#f92672">{</span><span style="color:#e6db74">&#34;count&#34;</span>:-1<span style="color:#f92672">}}</span>,
... <span style="color:#f92672">{</span><span style="color:#e6db74">&#34;</span>$limit<span style="color:#e6db74">&#34;</span>:3<span style="color:#f92672">})</span>
<span style="color:#f92672">{</span> <span style="color:#e6db74">&#34;_id&#34;</span> : <span style="color:#e6db74">&#34;dxy&#34;</span>, <span style="color:#e6db74">&#34;count&#34;</span> : <span style="color:#ae81ff">18</span> <span style="color:#f92672">}</span>
<span style="color:#f92672">{</span> <span style="color:#e6db74">&#34;_id&#34;</span> : <span style="color:#e6db74">&#34;yrq&#34;</span>, <span style="color:#e6db74">&#34;count&#34;</span> : <span style="color:#ae81ff">10</span> <span style="color:#f92672">}</span>
<span style="color:#f92672">{</span> <span style="color:#e6db74">&#34;_id&#34;</span> : <span style="color:#e6db74">&#34;rizu&#34;</span>, <span style="color:#e6db74">&#34;count&#34;</span> : <span style="color:#ae81ff">7</span> <span style="color:#f92672">}</span>
</code></pre></div><p>其中</p>
<ul>
<li>$project是投射操作，使用{filename:1}取出所需字段，使用{filename:0}排除指定字段。</li>
<li>$group是分组操作，这里对name进行分组，每遇到相同的name时则对对应的文档count值加一。</li>
<li>$sort是排序操作，由于要得到评论数最多的，因此这里使用降序排序。</li>
<li>$limit是限制操作，限制返回文档的数量。</li>
</ul>
<h3 id="管道操作符">管道操作符</h3>
<ol>
<li>
<p>$match</p>
<p>筛选出符合条件的文档，之后进行其它聚合操作。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">&gt; db.comments.aggregate<span style="color:#f92672">({</span><span style="color:#e6db74">&#34;</span>$match<span style="color:#e6db74">&#34;</span>:<span style="color:#f92672">{</span><span style="color:#e6db74">&#34;name&#34;</span>:<span style="color:#e6db74">&#34;rizu&#34;</span><span style="color:#f92672">}})</span>
<span style="color:#f92672">{</span> <span style="color:#e6db74">&#34;_id&#34;</span> : ObjectId<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;58e8cc36d574ca3ad45a97cd&#34;</span><span style="color:#f92672">)</span>, <span style="color:#e6db74">&#34;name&#34;</span> : <span style="color:#e6db74">&#34;rizu&#34;</span>, <span style="color:#e6db74">&#34;date&#34;</span> : ISODate<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;2017-04-08T11:40:38.893Z&#34;</span><span style="color:#f92672">)</span>, <span style="color:#e6db74">&#34;content&#34;</span> : <span style="color:#e6db74">&#34;hi&#34;</span> <span style="color:#f92672">}</span>
...
</code></pre></div></li>
<li>
<p>$project</p>
<p>投射操作，可以提取与重命名指定字段，还可使用数学与字符串操作符进行其他操作。</p>
<ol>
<li>
<p>提取与排除指定字段</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">&gt; db.comments.aggregate<span style="color:#f92672">({</span><span style="color:#e6db74">&#34;</span>$project<span style="color:#e6db74">&#34;</span>:<span style="color:#f92672">{</span><span style="color:#e6db74">&#34;name&#34;</span>:1,<span style="color:#e6db74">&#34;_id&#34;</span>:0<span style="color:#f92672">}})</span>
<span style="color:#f92672">{</span> <span style="color:#e6db74">&#34;name&#34;</span> : <span style="color:#e6db74">&#34;yrq&#34;</span> <span style="color:#f92672">}</span>
...
</code></pre></div></li>
<li>
<p>重命名字段</p>
</li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">&gt; db.comments.aggregate<span style="color:#f92672">({</span><span style="color:#e6db74">&#34;</span>$project<span style="color:#e6db74">&#34;</span>:<span style="color:#f92672">{</span><span style="color:#e6db74">&#34;user&#34;</span>:<span style="color:#e6db74">&#34;</span>$name<span style="color:#e6db74">&#34;</span><span style="color:#f92672">}})</span>
<span style="color:#f92672">{</span> <span style="color:#e6db74">&#34;_id&#34;</span> : ObjectId<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;58e8cbeed574ca3ad45a97ac&#34;</span><span style="color:#f92672">)</span>, <span style="color:#e6db74">&#34;user&#34;</span> : <span style="color:#e6db74">&#34;yrq&#34;</span> <span style="color:#f92672">}</span>
...
</code></pre></div></li>
<li>
<p>$group
通过指定字段的不同值分组。如根据date分组，并记录每个date时的评论数量。</p>
</li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">&gt; db.comments.aggregate<span style="color:#f92672">({</span><span style="color:#e6db74">&#34;</span>$group<span style="color:#e6db74">&#34;</span>:<span style="color:#f92672">{</span><span style="color:#e6db74">&#34;_id&#34;</span>:<span style="color:#e6db74">&#34;</span>$date<span style="color:#e6db74">&#34;</span>,<span style="color:#e6db74">&#34;total&#34;</span>:<span style="color:#f92672">{</span><span style="color:#e6db74">&#34;</span>$sum<span style="color:#e6db74">&#34;</span>:1<span style="color:#f92672">}}})</span>
<span style="color:#f92672">{</span> <span style="color:#e6db74">&#34;_id&#34;</span> : ISODate<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;2017-04-08T11:40:38.897Z&#34;</span><span style="color:#f92672">)</span>, <span style="color:#e6db74">&#34;total&#34;</span> : <span style="color:#ae81ff">1</span> <span style="color:#f92672">}</span>
<span style="color:#f92672">{</span> <span style="color:#e6db74">&#34;_id&#34;</span> : ISODate<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;2017-04-08T11:40:38.896Z&#34;</span><span style="color:#f92672">)</span>, <span style="color:#e6db74">&#34;total&#34;</span> : <span style="color:#ae81ff">2</span> <span style="color:#f92672">}</span>
<span style="color:#f92672">{</span> <span style="color:#e6db74">&#34;_id&#34;</span> : ISODate<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;2017-04-08T11:39:26.703Z&#34;</span><span style="color:#f92672">)</span>, <span style="color:#e6db74">&#34;total&#34;</span> : <span style="color:#ae81ff">2</span> <span style="color:#f92672">}</span>
...
</code></pre></div><ol start="4">
<li>$unwind
将数组中的值拆分为不同文档。先给用户yrq添加一个喜好数组。</li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">&gt; db.comments.update<span style="color:#f92672">({</span><span style="color:#e6db74">&#34;name&#34;</span>:<span style="color:#e6db74">&#34;yrq&#34;</span><span style="color:#f92672">}</span>,<span style="color:#f92672">{</span>$set:<span style="color:#f92672">{</span><span style="color:#e6db74">&#34;hobby&#34;</span>:<span style="color:#f92672">[{</span><span style="color:#e6db74">&#34;sport&#34;</span>:<span style="color:#e6db74">&#34;soccer&#34;</span><span style="color:#f92672">}</span>,<span style="color:#f92672">{</span><span style="color:#e6db74">&#34;lang&#34;</span>:<span style="color:#e6db74">&#34;en&#34;</span><span style="color:#f92672">}]}})</span>
</code></pre></div><p>使用$unwind操作符拆分喜好数组。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">&gt; db.comments.aggregate<span style="color:#f92672">({</span><span style="color:#e6db74">&#34;</span>$unwind<span style="color:#e6db74">&#34;</span>:<span style="color:#e6db74">&#34;</span>$hobby<span style="color:#e6db74">&#34;</span><span style="color:#f92672">})</span>
<span style="color:#f92672">{</span> <span style="color:#e6db74">&#34;_id&#34;</span> : ObjectId<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;58e8cbeed574ca3ad45a97ac&#34;</span><span style="color:#f92672">)</span>, <span style="color:#e6db74">&#34;name&#34;</span> : <span style="color:#e6db74">&#34;yrq&#34;</span>, <span style="color:#e6db74">&#34;date&#34;</span> : ISODate<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;2017-04-08T11:39:26.667Z&#34;</span><span style="color:#f92672">)</span>, <span style="color:#e6db74">&#34;content&#34;</span> : <span style="color:#e6db74">&#34;hello&#34;</span>, <span style="color:#e6db74">&#34;hobby&#34;</span> : <span style="color:#f92672">{</span> <span style="color:#e6db74">&#34;sport&#34;</span> : <span style="color:#e6db74">&#34;soccer&#34;</span> <span style="color:#f92672">}</span> <span style="color:#f92672">}</span>
<span style="color:#f92672">{</span> <span style="color:#e6db74">&#34;_id&#34;</span> : ObjectId<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;58e8cbeed574ca3ad45a97ac&#34;</span><span style="color:#f92672">)</span>, <span style="color:#e6db74">&#34;name&#34;</span> : <span style="color:#e6db74">&#34;yrq&#34;</span>, <span style="color:#e6db74">&#34;date&#34;</span> : ISODate<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;2017-04-08T11:39:26.667Z&#34;</span><span style="color:#f92672">)</span>, <span style="color:#e6db74">&#34;content&#34;</span> : <span style="color:#e6db74">&#34;hello&#34;</span>, <span style="color:#e6db74">&#34;hobby&#34;</span> : <span style="color:#f92672">{</span> <span style="color:#e6db74">&#34;lang&#34;</span> : <span style="color:#e6db74">&#34;en&#34;</span> <span style="color:#f92672">}</span> <span style="color:#f92672">}</span>
</code></pre></div><ol start="5">
<li>$limit
限制返回文档的数量。</li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">&gt; db.comments.aggregate<span style="color:#f92672">({</span><span style="color:#e6db74">&#34;</span>$limit<span style="color:#e6db74">&#34;</span>:2<span style="color:#f92672">})</span>
<span style="color:#f92672">{</span> <span style="color:#e6db74">&#34;_id&#34;</span> : ObjectId<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;58e8cbeed574ca3ad45a97ac&#34;</span><span style="color:#f92672">)</span>, <span style="color:#e6db74">&#34;name&#34;</span> : <span style="color:#e6db74">&#34;yrq&#34;</span>, <span style="color:#e6db74">&#34;date&#34;</span> : ISODate<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;2017-04-08T11:39:26.667Z&#34;</span><span style="color:#f92672">)</span>, <span style="color:#e6db74">&#34;content&#34;</span> : <span style="color:#e6db74">&#34;hello&#34;</span> <span style="color:#f92672">}</span>
<span style="color:#f92672">{</span> <span style="color:#e6db74">&#34;_id&#34;</span> : ObjectId<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;58e8cbeed574ca3ad45a97ad&#34;</span><span style="color:#f92672">)</span>, <span style="color:#e6db74">&#34;name&#34;</span> : <span style="color:#e6db74">&#34;yrq&#34;</span>, <span style="color:#e6db74">&#34;date&#34;</span> : ISODate<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;2017-04-08T11:39:26.699Z&#34;</span><span style="color:#f92672">)</span>, <span style="color:#e6db74">&#34;content&#34;</span> : <span style="color:#e6db74">&#34;hello&#34;</span> <span style="color:#f92672">}</span>
</code></pre></div><ol start="6">
<li>$skip
跳过指定数量的文档。</li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">&gt; db.comments.aggregate<span style="color:#f92672">({</span><span style="color:#e6db74">&#34;</span>$skip<span style="color:#e6db74">&#34;</span>:10<span style="color:#f92672">}</span>,<span style="color:#f92672">{</span><span style="color:#e6db74">&#34;</span>$limit<span style="color:#e6db74">&#34;</span>:2<span style="color:#f92672">})</span>
<span style="color:#f92672">{</span> <span style="color:#e6db74">&#34;_id&#34;</span> : ObjectId<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;58e8cbfed574ca3ad45a97b6&#34;</span><span style="color:#f92672">)</span>, <span style="color:#e6db74">&#34;name&#34;</span> : <span style="color:#e6db74">&#34;yy&#34;</span>, <span style="color:#e6db74">&#34;date&#34;</span> : ISODate<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;2017-04-08T11:39:42.989Z&#34;</span><span style="color:#f92672">)</span>, <span style="color:#e6db74">&#34;content&#34;</span> : <span style="color:#e6db74">&#34;h&#34;</span> <span style="color:#f92672">}</span>
<span style="color:#f92672">{</span> <span style="color:#e6db74">&#34;_id&#34;</span> : ObjectId<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;58e8cbfed574ca3ad45a97b7&#34;</span><span style="color:#f92672">)</span>, <span style="color:#e6db74">&#34;name&#34;</span> : <span style="color:#e6db74">&#34;yy&#34;</span>, <span style="color:#e6db74">&#34;date&#34;</span> : ISODate<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;2017-04-08T11:39:42.990Z&#34;</span><span style="color:#f92672">)</span>, <span style="color:#e6db74">&#34;content&#34;</span> : <span style="color:#e6db74">&#34;h&#34;</span> <span style="color:#f92672">}</span>
</code></pre></div><h3 id="mapreduce">MapReduce</h3>
<p>使用MapReduce的几个步骤:</p>
<ol>
<li>map(映射) - 将操作映射到集合中的文档，操作可以无任何行为或产生一些键和值。</li>
<li>shuffle(洗牌) - 中间环节，按照键分组，将产生的键值组成列表放到对应的键中。</li>
<li>reduce(化简) - 把列表中的值化简为单值并返回，然后继续洗牌，直到每个键的列表只有一个值为止。</li>
</ol>
<p>例：找出comments集合中的所有键并统计个数。
首先编写map函数得到文档中的所有键，使用emit函数返回某个键的计数{count:1}。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">&gt; map <span style="color:#f92672">=</span> <span style="color:#66d9ef">function</span><span style="color:#f92672">(){</span>
...  <span style="color:#66d9ef">for</span><span style="color:#f92672">(</span>var key in this<span style="color:#f92672">){</span>
...    emit<span style="color:#f92672">(</span>key,<span style="color:#f92672">{</span>count:1<span style="color:#f92672">})</span>;
... <span style="color:#f92672">}}</span>;
</code></pre></div><p>编写reduce函数，统计emit，reduce函数需要在之前的map阶段与前一个reduce产生的结果上反复执行，因此它返回的文档必须能作为reduce的第二个参数的一个元素。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">&gt; reduce <span style="color:#f92672">=</span> <span style="color:#66d9ef">function</span><span style="color:#f92672">(</span>key,emits<span style="color:#f92672">){</span>
...   total <span style="color:#f92672">=</span> 0;
...   <span style="color:#66d9ef">for</span><span style="color:#f92672">(</span>var i in emits<span style="color:#f92672">){</span>
...     total <span style="color:#f92672">+=</span> emits<span style="color:#f92672">[</span>i<span style="color:#f92672">]</span>.count;
...   <span style="color:#f92672">}</span>
...   <span style="color:#66d9ef">return</span> <span style="color:#f92672">{</span><span style="color:#e6db74">&#34;count&#34;</span>:total<span style="color:#f92672">}</span>;
... <span style="color:#f92672">}</span>
</code></pre></div><p>执行mapReduce命令。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">&gt; db.comments.mapReduce<span style="color:#f92672">(</span>map,reduce,<span style="color:#f92672">{</span>out:<span style="color:#f92672">{</span><span style="color:#e6db74">&#34;inline&#34;</span>:1<span style="color:#f92672">}})</span>
<span style="color:#f92672">{</span>
	<span style="color:#e6db74">&#34;results&#34;</span> : <span style="color:#f92672">[</span>
		<span style="color:#f92672">{</span>
			<span style="color:#e6db74">&#34;_id&#34;</span> : <span style="color:#e6db74">&#34;_id&#34;</span>,
			<span style="color:#e6db74">&#34;value&#34;</span> : <span style="color:#f92672">{</span>
				<span style="color:#e6db74">&#34;count&#34;</span> : <span style="color:#ae81ff">40</span>
			<span style="color:#f92672">}</span>
		<span style="color:#f92672">}</span>,
		<span style="color:#f92672">{</span>
			<span style="color:#e6db74">&#34;_id&#34;</span> : <span style="color:#e6db74">&#34;content&#34;</span>,
			<span style="color:#e6db74">&#34;value&#34;</span> : <span style="color:#f92672">{</span>
				<span style="color:#e6db74">&#34;count&#34;</span> : <span style="color:#ae81ff">40</span>
			<span style="color:#f92672">}</span>
		<span style="color:#f92672">}</span>,
		<span style="color:#f92672">{</span>
			<span style="color:#e6db74">&#34;_id&#34;</span> : <span style="color:#e6db74">&#34;date&#34;</span>,
			<span style="color:#e6db74">&#34;value&#34;</span> : <span style="color:#f92672">{</span>
				<span style="color:#e6db74">&#34;count&#34;</span> : <span style="color:#ae81ff">40</span>
			<span style="color:#f92672">}</span>
		<span style="color:#f92672">}</span>,
		<span style="color:#f92672">{</span>
			<span style="color:#e6db74">&#34;_id&#34;</span> : <span style="color:#e6db74">&#34;hobby&#34;</span>,
			<span style="color:#e6db74">&#34;value&#34;</span> : <span style="color:#f92672">{</span>
				<span style="color:#e6db74">&#34;count&#34;</span> : <span style="color:#ae81ff">1</span>
			<span style="color:#f92672">}</span>
		<span style="color:#f92672">}</span>,
		<span style="color:#f92672">{</span>
			<span style="color:#e6db74">&#34;_id&#34;</span> : <span style="color:#e6db74">&#34;name&#34;</span>,
			<span style="color:#e6db74">&#34;value&#34;</span> : <span style="color:#f92672">{</span>
				<span style="color:#e6db74">&#34;count&#34;</span> : <span style="color:#ae81ff">40</span>
			<span style="color:#f92672">}</span>
		<span style="color:#f92672">}</span>
	<span style="color:#f92672">]</span>,
	<span style="color:#e6db74">&#34;timeMillis&#34;</span> : 18,
	<span style="color:#e6db74">&#34;counts&#34;</span> : <span style="color:#f92672">{</span>
		<span style="color:#e6db74">&#34;input&#34;</span> : 40,
		<span style="color:#e6db74">&#34;emit&#34;</span> : 161,
		<span style="color:#e6db74">&#34;reduce&#34;</span> : 4,
		<span style="color:#e6db74">&#34;output&#34;</span> : <span style="color:#ae81ff">5</span>
	<span style="color:#f92672">}</span>,
	<span style="color:#e6db74">&#34;ok&#34;</span> : <span style="color:#ae81ff">1</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>第一个参数为map函数，第二个参数为reduce函数，第三个参数设置query、output、sort和limit等。</p>
<h3 id="聚合命令">聚合命令</h3>
<ol>
<li>
<p>count</p>
<p>返回集合中的文档数量。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">&gt; db.comments.count<span style="color:#f92672">()</span>
<span style="color:#ae81ff">40</span>
</code></pre></div></li>
<li>
<p>distinct</p>
<p>找出指定键的不同值，需要输入集合和键名。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">&gt; db.runCommand<span style="color:#f92672">({</span><span style="color:#e6db74">&#34;distinct&#34;</span>:<span style="color:#e6db74">&#34;comments&#34;</span>,<span style="color:#e6db74">&#34;key&#34;</span>:<span style="color:#e6db74">&#34;name&#34;</span><span style="color:#f92672">})</span>
<span style="color:#f92672">{</span> <span style="color:#e6db74">&#34;values&#34;</span> : <span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;yrq&#34;</span>, <span style="color:#e6db74">&#34;yy&#34;</span>, <span style="color:#e6db74">&#34;dxy&#34;</span>, <span style="color:#e6db74">&#34;rizu&#34;</span> <span style="color:#f92672">]</span>, <span style="color:#e6db74">&#34;ok&#34;</span> : <span style="color:#ae81ff">1</span> <span style="color:#f92672">}</span>
</code></pre></div></li>
<li>
<p>group</p>
<p>3.4版本以后弃用了group命令，可以使用db.collection.aggregate()结合$group操作符或者db.collection.mapReduce()替换。</p>
</li>
<li>
<p>aggreagate &amp; mapReduce</p>
<p>上面已介绍。</p>
</li>
</ol>
<h2 id="参考">参考</h2>
<ul>
<li><a href="https://docs.mongodb.com/manual/">The MongoDB 3.4 Manual</a></li>
<li><a href="https://www.amazon.cn/%E5%9B%BE%E4%B9%A6/dp/B00HLX035Q/ref=sr_1_1?ie=UTF8&amp;qid=1491184176&amp;sr=8-1&amp;keywords=mongodb%E6%9D%83%E5%A8%81%E6%8C%87%E5%8D%97">MongoDB权威指南(第2版)</a></li>
</ul>
        </div>

        
<div class="post-archive">
    <ul class="post-copyright">
        <li><strong>原文作者：</strong><a rel="author" href="http://yrq110.me/">yrq110</a></li>
        <li style="word-break:break-all"><strong>原文链接：</strong><a href="http://yrq110.me/post/database/mongo-travel-part-1/">http://yrq110.me/post/database/mongo-travel-part-1/</a></li>
        <li><strong>版权声明：</strong>本作品采用<a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/4.0/">知识共享署名-非商业性使用-禁止演绎 4.0 国际许可协议</a>进行许可，非商业转载请注明出处（作者，原文链接），商业转载请联系作者获得授权。</li>
    </ul>
</div>
<br/>



        


        <div class="post-meta meta-tags">
            
            <ul class="clearfix">
                
                <li><a href='http://yrq110.me/tags/mongo'>mongo</a></li>
                
            </ul>
            
        </div>
    </article>
    
    

    
    
    <div class="post bg-white">
      <script src="https://utteranc.es/client.js"
            repo= "yrq110/blog-comments"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
      </script>
    </div>
    
</div>

                </div>

                <div id="secondary">
    <section class="widget">
        <form id="search" action='//www.google.com/search' method="get" accept-charset="utf-8" target="_blank" _lpchecked="1">
      
      <input type="text" name="q" maxlength="20" placeholder="Search">
      <input type="hidden" name="sitesearch" value="http://yrq110.me/">
      <button type="submit" class="submit icon-search"></button>
</form>
    </section>
    
    <section class="widget">
        <h3 class="widget-title">最近文章</h3>
<ul class="widget-list">
    
    <li>
        <a href="http://yrq110.me/post/front-end/deep-in-threejs-core-objects-ii-geometry/" title="深入学习Three.js核心对象之（二）Geometry">深入学习Three.js核心对象之（二）Geometry</a>
    </li>
    
    <li>
        <a href="http://yrq110.me/post/front-end/deep-in-threejs-core-objects-i-object3d/" title="深入学习Three.js核心对象之（一）Object3D">深入学习Three.js核心对象之（一）Object3D</a>
    </li>
    
    <li>
        <a href="http://yrq110.me/post/computer-graphics/euler-angles-gimbal-lock-and-quaternion/" title="欧拉角、万向节死锁与四元数">欧拉角、万向节死锁与四元数</a>
    </li>
    
    <li>
        <a href="http://yrq110.me/post/front-end/arrow-function-in-class-proporties/" title="class中的箭头函数会输出什么">class中的箭头函数会输出什么</a>
    </li>
    
    <li>
        <a href="http://yrq110.me/post/front-end/cross-domain-and-cross-document-communication/" title="Web通信中的跨文档通信">Web通信中的跨文档通信</a>
    </li>
    
    <li>
        <a href="http://yrq110.me/post/front-end/typescript-decorator-practice/" title="TypeScript装饰器整理及用例介绍">TypeScript装饰器整理及用例介绍</a>
    </li>
    
    <li>
        <a href="http://yrq110.me/post/front-end/dive-into-playwright/" title="跨平台的浏览器自动化工具Playwright简析">跨平台的浏览器自动化工具Playwright简析</a>
    </li>
    
    <li>
        <a href="http://yrq110.me/post/front-end/best-practice-of-typescript-in-webapp-developing/" title="使用TypeScript开发Web应用的最佳实践">使用TypeScript开发Web应用的最佳实践</a>
    </li>
    
    <li>
        <a href="http://yrq110.me/post/front-end/dive-into-2d-canvas-framework-iii-pixi/" title="Canvas2D渲染库简析:（三）Pixi">Canvas2D渲染库简析:（三）Pixi</a>
    </li>
    
    <li>
        <a href="http://yrq110.me/post/front-end/dive-into-2d-canvas-framework-ii-konva/" title="Canvas2D渲染库简析:（二）Konva">Canvas2D渲染库简析:（二）Konva</a>
    </li>
    
</ul>
    </section>

    

    <section class="widget">
        <h3 class="widget-title">分类</h3>
<ul class="widget-list">
    
    <li><a href="http://yrq110.me/categories/computer-graphics/">computer-graphics (1)</a></li>
    
    <li><a href="http://yrq110.me/categories/database/">database (2)</a></li>
    
    <li><a href="http://yrq110.me/categories/devops/">devops (5)</a></li>
    
    <li><a href="http://yrq110.me/categories/front-end/">front-end (23)</a></li>
    
    <li><a href="http://yrq110.me/categories/go/">go (1)</a></li>
    
    <li><a href="http://yrq110.me/categories/practice/">practice (2)</a></li>
    
</ul>
    </section>

    <section class="widget">
        <h3 class="widget-title">标签</h3>
<div class="tagcloud">
    
    <a href="http://yrq110.me/tags/blink/">blink</a>
    
    <a href="http://yrq110.me/tags/canvas/">canvas</a>
    
    <a href="http://yrq110.me/tags/chrome/">chrome</a>
    
    <a href="http://yrq110.me/tags/chromium/">chromium</a>
    
    <a href="http://yrq110.me/tags/cross-document/">cross-document</a>
    
    <a href="http://yrq110.me/tags/css/">css</a>
    
    <a href="http://yrq110.me/tags/docker/">docker</a>
    
    <a href="http://yrq110.me/tags/dom/">dom</a>
    
    <a href="http://yrq110.me/tags/e2e/">e2e</a>
    
    <a href="http://yrq110.me/tags/electron/">electron</a>
    
    <a href="http://yrq110.me/tags/event-loop/">event-loop</a>
    
    <a href="http://yrq110.me/tags/fabric/">fabric</a>
    
    <a href="http://yrq110.me/tags/git/">git</a>
    
    <a href="http://yrq110.me/tags/git-submodule/">git-submodule</a>
    
    <a href="http://yrq110.me/tags/github/">github</a>
    
    <a href="http://yrq110.me/tags/gpu/">gpu</a>
    
    <a href="http://yrq110.me/tags/houdini/">houdini</a>
    
    <a href="http://yrq110.me/tags/hugo/">hugo</a>
    
    <a href="http://yrq110.me/tags/iframe/">iframe</a>
    
    <a href="http://yrq110.me/tags/javascript/">javascript</a>
    
    <a href="http://yrq110.me/tags/konva/">konva</a>
    
    <a href="http://yrq110.me/tags/lerna/">lerna</a>
    
    <a href="http://yrq110.me/tags/libuv/">libuv</a>
    
    <a href="http://yrq110.me/tags/maupassant/">maupassant</a>
    
    <a href="http://yrq110.me/tags/mongo/">mongo</a>
    
    <a href="http://yrq110.me/tags/mpvue/">mpvue</a>
    
    <a href="http://yrq110.me/tags/node/">node</a>
    
    <a href="http://yrq110.me/tags/offscreen-canvas/">offscreen canvas</a>
    
    <a href="http://yrq110.me/tags/pixi/">pixi</a>
    
    <a href="http://yrq110.me/tags/playwright/">playwright</a>
    
    <a href="http://yrq110.me/tags/postmessage/">postMessage</a>
    
    <a href="http://yrq110.me/tags/puppeteer/">puppeteer</a>
    
    <a href="http://yrq110.me/tags/quaternion/">quaternion</a>
    
    <a href="http://yrq110.me/tags/rendering-pipeline/">rendering pipeline</a>
    
    <a href="http://yrq110.me/tags/rotation/">rotation</a>
    
    <a href="http://yrq110.me/tags/skia/">skia</a>
    
    <a href="http://yrq110.me/tags/ssh/">ssh</a>
    
    <a href="http://yrq110.me/tags/svg/">svg</a>
    
    <a href="http://yrq110.me/tags/threejs/">threejs</a>
    
    <a href="http://yrq110.me/tags/typescript/">typescript</a>
    
    <a href="http://yrq110.me/tags/vue/">vue</a>
    
    <a href="http://yrq110.me/tags/web-worker/">web worker</a>
    
    <a href="http://yrq110.me/tags/webgpu/">webgpu</a>
    
    <a href="http://yrq110.me/tags/websocket/">websocket</a>
    
    <a href="http://yrq110.me/tags/wxapp/">wxapp</a>
    
    <a href="http://yrq110.me/tags/yarn/">yarn</a>
    
</div>
    </section>

    
<section class="widget">
    <h3 class="widget-title">友情链接</h3>
    <ul class="widget-list">
        
        <li>
            <a target="_blank" href="https://taoyuan.fun/" title="taoyuan">taoyuan</a>
        </li>
        
        <li>
            <a target="_blank" href="https://blog.cshayne.cn/" title="cshayne">cshayne</a>
        </li>
        
    </ul>
</section>


    <section class="widget">
        <h3 class="widget-title">其它</h3>
        <ul class="widget-list">
            <li><a href="http://yrq110.me/index.xml">文章 RSS</a></li>
        </ul>
    </section>
</div>
            </div>
        </div>
    </div>
    <footer id="footer">
    <div class="container">
        &copy; 2020 <a href="http://yrq110.me/">￥ЯႭ1I0 By yrq110</a>.
        Powered by <a rel="nofollow noreferer noopener" href="https://gohugo.io" target="_blank">Hugo</a>.
        <a href="https://www.flysnow.org/" target="_blank">Theme</a> based on <a href="https://github.com/flysnow-org/maupassant-hugo" target="_blank">maupassant</a>.
        
    </div>
</footer>


    
    <script type="text/javascript">
        window.MathJax = {
            tex2jax: {
                inlineMath: [['$', '$']],
                processEscapes: true
                }
            };
    </script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML' async></script>


<a id="rocket" href="#top"></a>
<script type="text/javascript" src='/js/totop.js?v=0.0.0' async=""></script>

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-131471642-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>






</body>

</html>