<!doctype html>
<html lang="zh-CN">
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>了解一下CSS Houdini API | ￥ЯႭ1I0</title>
    <meta property="og:title" content="了解一下CSS Houdini API - ￥ЯႭ1I0">
    <meta property="og:type" content="article">
        
    <meta property="article:published_time" content='2019-04-18T18:08:25&#43;08:00'>
        
        
    <meta property="article:modified_time" content='2019-04-18T18:08:25&#43;08:00'>
        
    <meta name="Keywords" content="">
    <meta name="description" content="了解一下CSS Houdini API">
        
    <meta name="author" content="yrq110">
    <meta property="og:url" content="http://yrq110.me/post/front-end/try-houdini-api/">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">

    <link rel="stylesheet" href='/css/normalize.css'>
    <link rel="stylesheet" href='/css/style.css'>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

    


    
    
</head>


<body>
    <header id="header" class="clearfix">
    <div class="container">
        <div class="col-group">
            <div class="site-name ">
                
                    <a id="logo" href="http://yrq110.me/">
                        ￥ЯႭ1I0
                    </a>
                
                
            </div>
            <div>
                <nav id="nav-menu" class="clearfix">
                    <a class="current" href="http://yrq110.me/">首页</a>
                    
                    <a  href="http://yrq110.me/archives/" title="归档">归档</a>
                    
                    <a  href="http://yrq110.me/about/" title="关于">关于</a>
                    
                </nav>
            </div>
        </div>
    </div>
</header>

    <div id="body">
        <div class="container">
            <div class="col-group">

                <div class="col-8" id="main">
                    
<div class="res-cons">
    
    <article class="post">
        <header>
            <h1 class="post-title">了解一下CSS Houdini API</h1>
        </header>
        <date class="post-meta meta-date">
            2019年4月18日
        </date>
        
        <div class="post-meta">
            <span>|</span>
            
            <span class="meta-category"><a href='http://yrq110.me/categories/front-end'>front-end</a></span>
            
        </div>
        
        
        
        <div class="post-content">
            <p>Houdini, in essence, gives developers lower level access to CSS itself.</p>
<ul>
<li>Worklets, TypedOM, Custom Properties</li>
<li>Paint API, Animation API, Layout API</li>
</ul>
<h1 id="css-houdini-api">CSS Houdini API</h1>
<h2 id="tldr">TL;DR</h2>
<p>Houdini API主要包含一下六个部分:</p>
<table>
<thead>
<tr>
<th>类别</th>
<th>简称</th>
<th>Spec全称</th>
<th>特点</th>
</tr>
</thead>
<tbody>
<tr>
<td>多线程</td>
<td><a href="https://drafts.css-houdini.org/worklets/">Worklets</a></td>
<td>Worklets Level 1</td>
<td>使用多线程执行渲染引擎的指定类型任务，提高整体性能</td>
</tr>
<tr>
<td>CSS对象模型</td>
<td><a href="https://drafts.css-houdini.org/css-typed-om/">TypedOM</a></td>
<td>CSS Typed OM Level 1</td>
<td>使用JS操作CSSOM属性</td>
</tr>
<tr>
<td>自定义属性</td>
<td><a href="https://drafts.css-houdini.org/css-properties-values-api/">Custom Properties</a></td>
<td>CSS Properties and Values API Level 1</td>
<td>在JS主进程中定义与类型化CSS属性</td>
</tr>
<tr>
<td>绘制</td>
<td><a href="https://drafts.css-houdini.org/css-paint-api/">Paint API</a></td>
<td>CSS Painting API Level 1</td>
<td>使用类canvas上下文在元素背景与mask中自由绘制</td>
</tr>
<tr>
<td>动画</td>
<td><a href="https://drafts.css-houdini.org/css-animationworklet/">Animation API</a></td>
<td>CSS Animation Worklet API</td>
<td>使用JS与worklet操作元素帧动画的效果与时间</td>
</tr>
<tr>
<td>布局</td>
<td><a href="https://drafts.css-houdini.org/css-layout-api">Layout API</a></td>
<td>CSS Layout API Level 1</td>
<td>通过类逻辑属性与worklet自由地布局元素</td>
</tr>
</tbody>
</table>
<blockquote>
<p><strong>注意:</strong> 目前在chrome使用这些API可能需要手动开启web实验性功能选项。</p>
</blockquote>
<blockquote>
<p><strong>开启方法:</strong> 进入<code>chrome://flags/</code>地址，将<code>Experimental Web Platform features</code>启用即可。</p>
</blockquote>
<h1 id="worklet">Worklet</h1>
<p>渲染引擎的扩展模块，类似web worker，也是开启新的线程去执行指定任务。</p>
<p>具有以下两个核心概念:</p>
<ol>
<li>并行设计 - 每个Worklet必须拥有2个及以上的实例，每个实例都会在被调用时实际运行</li>
<li>域的限制 - 只能访问一些全局域下的方法或对象，比如<code>setTimeout</code>(这一点类似worker)</li>
</ol>
<h2 id="如何使用">如何使用</h2>
<p>Worklet属于JS模块，通过调用worklet对象的<code>addModule</code>函数来添加，该函数会返回一个Promise。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#75715e">// 在浏览器上下文中加载worklet
</span><span style="color:#75715e"></span><span style="color:#a6e22e">await</span> <span style="color:#a6e22e">demoWorklet</span>.<span style="color:#a6e22e">addModule</span>(<span style="color:#e6db74">&#39;path/to/script.js&#39;</span>);

<span style="color:#75715e">// 也可以一次性加载多个worklet
</span><span style="color:#75715e"></span>Promise.<span style="color:#a6e22e">all</span>([
  <span style="color:#a6e22e">demoWorklet1</span>.<span style="color:#a6e22e">addModule</span>(<span style="color:#e6db74">&#39;script1.js&#39;</span>),
  <span style="color:#a6e22e">demoWorklet2</span>.<span style="color:#a6e22e">addModule</span>(<span style="color:#e6db74">&#39;script2.js&#39;</span>),
]).<span style="color:#a6e22e">then</span>(<span style="color:#a6e22e">results</span> =&gt; {
  <span style="color:#75715e">// 待worklet都加载完成，可以基于此做一些其他工作
</span><span style="color:#75715e"></span>});
</code></pre></div><p>worklet文件的内容结构大同小异，均有一个在全局作用域的注册函数，该函数接收一个注册的名称和一个针对指定类型worklet设计的类。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#75715e">// 一个worklet大概长这个样子
</span><span style="color:#75715e"></span><span style="color:#a6e22e">registerDemoWorklet</span>(<span style="color:#e6db74">&#39;name&#39;</span>, <span style="color:#66d9ef">class</span> {
  <span style="color:#75715e">// 每种worklet中都需要定义渲染引擎所需的函数
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">process</span>(<span style="color:#a6e22e">arg</span>) {
    <span style="color:#75715e">// 具体功能取决于worklet的种类
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// 有时可能会有返回值，有时也许会直接在参数上进行操作
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">return</span> <span style="color:#f92672">!</span><span style="color:#a6e22e">arg</span>;
  }
});
</code></pre></div><h2 id="生命周期">生命周期</h2>
<ol>
<li>从渲染引擎开始，启动一个主线程</li>
<li>接着会启动多个worklet所运行的worklet进程。为了不阻塞主线程，这些进程理论上是与主线程分离的。</li>
<li>在主线程中加载浏览器的JS脚本</li>
<li>JS中调用<code>worklet.addModule</code>异步加载一个worklet</li>
<li>一旦捕获到空闲的worklet进程，则worlet会加载到两个或更多的worklet进程中</li>
<li>当需要时，渲染引擎会从已加载的worklet中调用合适的进程来执行任务，这个调用可以是任何并行的worklet实例</li>
</ol>
<h1 id="typedom">TypedOM</h1>
<p><code>Typed OM</code>是对于已存在的CSSOM的扩展，它使用类型化JS对象暴露了CSS值，而不是像现在的一个简单的字符串，将字符串转换成有意义的类型会消耗很多性能，因此采用类型化JS对象的方式可以更有效率的处理CSS属性值。</p>
<p>在<code>Typed OM</code>中，CSS Value现在是一个新基类<code>CSSStyleValue</code>的成员变量，<code>CSSStyleValue</code>中包含大量用来描述具体CSS属性的子类：</p>
<ul>
<li><code>CSSKeywordValue</code> - CSS关键字或其他标识符(比如<code>inhert</code>或<code>grid</code>)</li>
<li><code>CSSPositionValue</code> - 坐标属性(<code>x</code>, <code>y</code>)值</li>
<li><code>CSSImageValue</code> - 表示图像属性的对象</li>
<li><code>CSSUnitValue</code> - 数值型值。可以由一个数值与单位表示(比如50px)，也可以由无单位的数值或百分比表示</li>
<li><code>CSSMathValue</code> - 复杂的数值型值。比如使用了<code>calc</code>,<code>min</code>,<code>max</code>等函数得到结果，包含很多子类：<code>CSSMathSum</code>, <code>CSSMathProduct</code>, <code>CSSMathMin</code>, <code>CSSMathMax</code>, <code>CSSMathNegate</code>, <code>CSSMathInvert</code></li>
<li><code>CSSTransformValue</code> - 由CSSTransformComponents组成的一个CSS变换列表，包含CSSTranslate, CSSRotate, CSSScale, CSSSkew, CSSSkewX, CSSSkewY, CSSPerspective 或 CSSMatrixComponent</li>
</ul>
<h2 id="如何使用-1">如何使用</h2>
<p>与Typed OM相关的两个重要方法：<code>attributeStyleMap</code>和<code>computedStyleMap</code></p>
<ul>
<li><code>attributeStyleMap</code> - 用来get与set类型化样式</li>
<li><code>computedStyleMap</code> - 用来get一个元素完整的Typed OM样式</li>
</ul>
<h3 id="attributestylemap">attributeStyleMap</h3>
<p>在设置属性值时，有多个数值函数可以用来处理它们(与关键字值不同)</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#a6e22e">myElement</span>.<span style="color:#a6e22e">attributeStyleMap</span>.<span style="color:#a6e22e">set</span>(<span style="color:#e6db74">&#39;font-size&#39;</span>, <span style="color:#a6e22e">CSS</span>.<span style="color:#a6e22e">em</span>(<span style="color:#ae81ff">2</span>));
<span style="color:#a6e22e">myElement</span>.<span style="color:#a6e22e">attributeStyleMap</span>.<span style="color:#a6e22e">get</span>(<span style="color:#e6db74">&#39;font-size&#39;</span>); <span style="color:#75715e">// CSSUnitValue { value: 2, unit: &#39;em&#39; }
</span><span style="color:#75715e"></span>
<span style="color:#a6e22e">myElement</span>.<span style="color:#a6e22e">attributeStyleMap</span>.<span style="color:#a6e22e">set</span>(<span style="color:#e6db74">&#39;opacity&#39;</span>, <span style="color:#a6e22e">CSS</span>.<span style="color:#a6e22e">number</span>(<span style="color:#ae81ff">.5</span>));
<span style="color:#a6e22e">myElement</span>.<span style="color:#a6e22e">attributeStyleMap</span>.<span style="color:#a6e22e">get</span>(<span style="color:#e6db74">&#39;opacity&#39;</span>); <span style="color:#75715e">// CSSUnitValue { value: 0.5, unit: &#39;number&#39; };
</span></code></pre></div><h3 id="computedstylemap">computedStyleMap</h3>
<p>一个css片段</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-css" data-lang="css">.<span style="color:#a6e22e">foo</span> {
  <span style="color:#66d9ef">background-position</span>: <span style="color:#66d9ef">center</span> <span style="color:#66d9ef">bottom</span> <span style="color:#ae81ff">10</span><span style="color:#66d9ef">px</span>;
  <span style="color:#66d9ef">transform</span>: translateX(<span style="color:#ae81ff">1</span><span style="color:#66d9ef">em</span>) rotate(<span style="color:#ae81ff">50</span><span style="color:#66d9ef">deg</span>) skewX(<span style="color:#ae81ff">10</span><span style="color:#66d9ef">deg</span>);
  <span style="color:#66d9ef">vertical-align</span>: <span style="color:#66d9ef">baseline</span>;
  <span style="color:#66d9ef">width</span>: calc(<span style="color:#ae81ff">100</span><span style="color:#66d9ef">%</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">3</span><span style="color:#66d9ef">em</span>);
}
</code></pre></div><p>使用computedStyleMap获取对应关键字的完整属性值，对应的js操作如下</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">cs</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">$</span>(<span style="color:#e6db74">&#39;.foo&#39;</span>).<span style="color:#a6e22e">computedStyleMap</span>();

<span style="color:#a6e22e">cs</span>.<span style="color:#a6e22e">get</span>(<span style="color:#e6db74">&#39;vertical-align&#39;</span>);
<span style="color:#75715e">// CSSKeywordValue {
</span><span style="color:#75715e">//  value: &#39;baseline&#39;,
</span><span style="color:#75715e">// }
</span><span style="color:#75715e"></span>
<span style="color:#a6e22e">cs</span>.<span style="color:#a6e22e">get</span>(<span style="color:#e6db74">&#39;background-position&#39;</span>).<span style="color:#a6e22e">x</span>;
<span style="color:#75715e">// CSSUnitValue {
</span><span style="color:#75715e">//   value: 50,
</span><span style="color:#75715e">//   unit: &#39;percent&#39;,
</span><span style="color:#75715e">// }
</span><span style="color:#75715e"></span>
<span style="color:#a6e22e">cs</span>.<span style="color:#a6e22e">get</span>(<span style="color:#e6db74">&#39;background-position&#39;</span>).<span style="color:#a6e22e">y</span>;
<span style="color:#75715e">// CSSMathSum {
</span><span style="color:#75715e">//   operator: &#39;sum&#39;,
</span><span style="color:#75715e">//   values: CSSNumericArray {
</span><span style="color:#75715e">//     0: CSSUnitValue { value: -10, unit: &#39;px&#39; },
</span><span style="color:#75715e">//     1: CSSUnitValue { value: 100, unit: &#39;percent&#39; },
</span><span style="color:#75715e">//   },
</span><span style="color:#75715e">// }
</span><span style="color:#75715e"></span>
<span style="color:#a6e22e">cs</span>.<span style="color:#a6e22e">get</span>(<span style="color:#e6db74">&#39;width&#39;</span>);
<span style="color:#75715e">// CSSMathSum {
</span><span style="color:#75715e">//   operator: &#39;sum&#39;,
</span><span style="color:#75715e">//   length: 2,
</span><span style="color:#75715e">//   values: CSSNumericArray {
</span><span style="color:#75715e">//     0: CSSUnitValue { value: -90, unit: &#39;px&#39; },
</span><span style="color:#75715e">//     1: CSSUnitValue { value: 100, unit: &#39;percent&#39; },
</span><span style="color:#75715e">//   },
</span><span style="color:#75715e">// }
</span><span style="color:#75715e"></span>
<span style="color:#a6e22e">cs</span>.<span style="color:#a6e22e">get</span>(<span style="color:#e6db74">&#39;transform&#39;</span>);
<span style="color:#75715e">// CSSTransformValue {
</span><span style="color:#75715e">//   is2d: true,
</span><span style="color:#75715e">//   length: 3,
</span><span style="color:#75715e">//   0: CSSTranslate {
</span><span style="color:#75715e">//     is2d: true,
</span><span style="color:#75715e">//     x: CSSUnitValue { value: 20, unit: &#39;px&#39; },
</span><span style="color:#75715e">//     y: CSSUnitValue { value: 0, unit: &#39;px&#39; },
</span><span style="color:#75715e">//     z: CSSUnitValue { value: 0, unit: &#39;px&#39; },
</span><span style="color:#75715e">//   },
</span><span style="color:#75715e">//   1: CSSRotate {
</span><span style="color:#75715e">//     is2d: true,
</span><span style="color:#75715e">//     angle: CSSUnitValue { value: 50, unit: &#39;deg&#39; },
</span><span style="color:#75715e">//     x: CSSUnitValue { value: 0, unit: &#39;number&#39; },
</span><span style="color:#75715e">//     y: CSSUnitValue { value: 0, unit: &#39;number&#39; },
</span><span style="color:#75715e">//     z: CSSUnitValue { value: 1, unit: &#39;number&#39; },
</span><span style="color:#75715e">//   },
</span><span style="color:#75715e">//   2: CSSSkewX {
</span><span style="color:#75715e">//     is2d: true,
</span><span style="color:#75715e">//     ax: CSSUnitValue { value: 10, unit: &#39;deg&#39; },
</span><span style="color:#75715e">//   },
</span><span style="color:#75715e">// }
</span></code></pre></div><h1 id="custom-properties">Custom Properties</h1>
<p>目前的<a href="https://www.w3.org/TR/css-variables-1/"><code>CSS Variables</code></a>特性提供了一种用户定义CSS属性值的方式，但限制了<code>var()</code>的外部引用(仅在CSS中使用)，并且不能被严格的定义(类型等)。</p>
<p>针对这些问题产生了<a href="https://drafts.css-houdini.org/css-properties-values-api/"><code>CSS Properties &amp; Values API Level 1</code></a>，即自定义属性，扩展了<code>CSS Variables</code>，允许我们注册属性并定义它们的类型、初始值和继承属性，极大提高了CSS属性变量的操作能力和灵活性。</p>
<h2 id="对比">对比</h2>
<p><strong>目前的CSS Variables</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-css" data-lang="css">.<span style="color:#a6e22e">thing</span> {
  --my-color: <span style="color:#66d9ef">green</span>;
  --my-color: url(<span style="color:#e6db74">&#39;not-a-color&#39;</span>); <span style="color:#960050;background-color:#1e0010">//</span> <span style="color:#960050;background-color:#1e0010">它只是一个变量，什么都不懂</span>
  <span style="color:#66d9ef">color</span>: <span style="color:#a6e22e">var</span>(<span style="color:#f92672">--</span>my<span style="color:#f92672">-</span><span style="color:#66d9ef">color</span>); <span style="color:#960050;background-color:#1e0010">//</span> <span style="color:#960050;background-color:#1e0010">这就尴尬了</span>
}
</code></pre></div><p><strong>Houdini自定义属性</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js">window.<span style="color:#a6e22e">CSS</span>.<span style="color:#a6e22e">registerProperty</span>({
  <span style="color:#a6e22e">name</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;--my-color&#39;</span>,
  <span style="color:#a6e22e">syntax</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;&lt;color&gt;&#39;</span>, <span style="color:#75715e">// 现在它定义了一个color，url这种值就会被跳过
</span><span style="color:#75715e"></span>});
</code></pre></div><h2 id="示例">示例</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#a6e22e">CSS</span>.<span style="color:#a6e22e">registerProperty</span>({
  <span style="color:#a6e22e">name</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;--foo&#39;</span>, <span style="color:#75715e">// String，自定义属性的名称
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">syntax</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;&lt;color&gt;&#39;</span>, <span style="color:#75715e">// String, 解析该属性的方式，默认为*
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">inherits</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">false</span>, <span style="color:#75715e">// Boolean, 若为true则会继承自DOM树
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">initialValue</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;black&#39;</span>, <span style="color:#75715e">// String, 该属性的初始值
</span><span style="color:#75715e"></span>});
</code></pre></div><p>在注册一个自定义属性时，有很多<a href="https://drafts.css-houdini.org/css-properties-values-api/#supported-syntax-strings">支持的syntax值</a>可供使用：<code>&lt;length&gt;</code>, <code>&lt;number&gt;</code>, <code>&lt;percentage&gt;</code>, <code>&lt;length-percentage&gt;</code>, <code>&lt;color</code>, <code>&lt;image&gt;</code>, <code>&lt;url&gt;</code>, <code>&lt;integer&gt;</code>等等</p>
<p>可以在使用空格分隔的列表中使用<code>+</code>表示包含多个syntax值(比如length)，使用<code>|</code>来分隔不同的可选synatx值。</p>
<h1 id="paint-api">Paint API</h1>
<p>CSS Painting API Level 1， 也被称为<code>Houdini Paint API</code>，它在CSS中使用图像的地方(背景、遮罩等)为我们提供了一种新的实现绘制自定义图样的方式。</p>
<p>使用全新的<code>paint()</code>函数与<code>Paint API worklet</code>，我们可以:</p>
<ul>
<li>使用类似2D Canvas的绘制上下文</li>
<li>基于元素尺寸缩放绘制的图像(重绘亦是)</li>
<li>通过自定义属性设置绘制样式</li>
</ul>
<h2 id="支持情况">支持情况</h2>
<p>Paint API的polyfill：<a href="https://github.com/GoogleChromeLabs/css-paint-polyfill">css-paint-polyfill</a></p>
<!-- raw HTML omitted -->
<h2 id="如何使用-2">如何使用</h2>
<h3 id="画一个圆">画一个圆</h3>
<p>比如现在我们想使用Paint API在某个元素的背景中画一个圆，主要分为如下三部分</p>
<ol>
<li>
<p>CSS部分</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-css" data-lang="css"><span style="color:#f92672">section</span> {
  <span style="color:#66d9ef">background-image</span>: <span style="color:#a6e22e">paint</span>(awesomePattern);
}<span style="color:#f92672">;</span>
</code></pre></div><p>在css的属性值中使用<code>paint()</code>函数加载指定worklet模块，参数为之后起的worklet模块名称。</p>
</li>
<li>
<p>JS部分</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#a6e22e">CSS</span>.<span style="color:#a6e22e">paintWorklet</span>.<span style="color:#a6e22e">addModule</span>(<span style="color:#e6db74">&#39;patternWorklet.js&#39;</span>);
</code></pre></div><p>使用<code>CSS.paintWorklet</code>的<code>addModule()</code>载入worklet。</p>
</li>
<li>
<p>worklet部分</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#75715e">// patternWorklet.js
</span><span style="color:#75715e"></span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Shape</span> {
  <span style="color:#a6e22e">paint</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">geom</span>, <span style="color:#a6e22e">properties</span>) {
    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">x</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">geom</span>.<span style="color:#a6e22e">width</span> <span style="color:#f92672">/</span> <span style="color:#ae81ff">2</span>;
    <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">y</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">geom</span>.<span style="color:#a6e22e">height</span> <span style="color:#f92672">/</span> <span style="color:#ae81ff">2</span>;

    <span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">strokeStyle</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;white&#39;</span>;
    <span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">lineWidth</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">4</span>;
    <span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">beginPath</span>();
    <span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">arc</span>(<span style="color:#a6e22e">x</span>, <span style="color:#a6e22e">y</span>, <span style="color:#ae81ff">50</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> Math.<span style="color:#a6e22e">PI</span>);
    <span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">stroke</span>();
    <span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">closePath</span>();
  }
}
<span style="color:#75715e">// Register our class under a specific name
</span><span style="color:#75715e"></span><span style="color:#a6e22e">registerPaint</span>(<span style="color:#e6db74">&#39;awesomePattern&#39;</span>, <span style="color:#a6e22e">Shape</span>);
</code></pre></div><p>主要是<code>paint()</code>与<code>registerPaint()</code>这两个函数。</p>
<ul>
<li><code>paint()</code>中会依次传入三个参数: <code>ctx</code>, <code>geom</code>, <code>properties</code>
<ul>
<li><code>ctx</code> (PaintRenderingContext2D) - 绘制上下文，与canvas类似，不同的是无法像在canvas中那样获取图像中的像素数据</li>
<li><code>geom</code> (PaintSize) - 表示绘制区域的尺寸，包含<code>height</code>与<code>width</code>属性</li>
<li><code>properties</code> (StylePropertyMapReadOnly) - 一个包含自定义属性与样式属性的只读Map，属性在<code>inputProperties</code>中导入</li>
</ul>
</li>
<li><code>registerPaint()</code>是Paint worklet的注册函数</li>
</ul>
</li>
</ol>
<h3 id="使用自定义属性">使用自定义属性</h3>
<p>在paint worklet中使用自定义属性仅需两步:</p>
<ol>
<li>
<p>CSS部分</p>
<p>在CSS中定义属性</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-css" data-lang="css"><span style="color:#f92672">section</span> {
  --circle-scale: <span style="color:#ae81ff">2</span>;  <span style="color:#960050;background-color:#1e0010">//</span> <span style="color:#960050;background-color:#1e0010">定义缩放比例</span>
  --circle-color: <span style="color:#66d9ef">red</span>;<span style="color:#960050;background-color:#1e0010">//</span> <span style="color:#960050;background-color:#1e0010">定义颜色</span>
  <span style="color:#960050;background-color:#1e0010">...</span>
}<span style="color:#f92672">;</span>
</code></pre></div></li>
<li>
<p>worklet部分</p>
<p>在worklet中取得属性值并绘制出来</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Shape</span> {
  <span style="color:#66d9ef">static</span> <span style="color:#a6e22e">get</span> <span style="color:#a6e22e">inputProperties</span>() { <span style="color:#66d9ef">return</span> [<span style="color:#e6db74">&#39;--circle-scale&#39;</span>,<span style="color:#e6db74">&#39;--circle-color&#39;</span>]; }
  <span style="color:#a6e22e">paint</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">geom</span>, <span style="color:#a6e22e">properties</span>) {
    ...
    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">scale</span> <span style="color:#f92672">=</span> parseInt(<span style="color:#a6e22e">properties</span>.<span style="color:#a6e22e">get</span>(<span style="color:#e6db74">&#39;--circle-scale&#39;</span>).<span style="color:#a6e22e">toString</span>()) <span style="color:#f92672">||</span> <span style="color:#ae81ff">1</span>;
    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">color</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">properties</span>.<span style="color:#a6e22e">get</span>(<span style="color:#e6db74">&#39;--circle-color&#39;</span>).<span style="color:#a6e22e">toString</span>() <span style="color:#f92672">||</span> <span style="color:#e6db74">&#39;white&#39;</span>;
    ...
    <span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">strokeStyle</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">color</span>;
    <span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">arc</span>(<span style="color:#a6e22e">x</span>, <span style="color:#a6e22e">y</span>, <span style="color:#ae81ff">50</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">scale</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> Math.<span style="color:#a6e22e">PI</span>);
    ...
  }
}
...
</code></pre></div></li>
</ol>
<h1 id="animation-api">Animation API</h1>
<p>CSS Animation Worklet API，即Animation API(注意，与<a href="https://drafts.csswg.org/web-animations/"><code>Web Animations</code></a>不同), 这个API提供了一种能力，使我们可以通过一种标准的、非阻塞的方式，根据用户的输入(比如滚动等)来驱动关键帧动画。</p>
<h2 id="支持情况-1">支持情况</h2>
<!-- raw HTML omitted -->
<h2 id="如何使用-3">如何使用</h2>
<p>要使用Animation API，需要创建一个<code>WorkletAnimation</code>实例来控制动画</p>
<ol>
<li>
<p>JS部分</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#75715e">// 1. 载入animation worklet
</span><span style="color:#75715e"></span><span style="color:#a6e22e">await</span> <span style="color:#a6e22e">CSS</span>.<span style="color:#a6e22e">animationWorklet</span>.<span style="color:#a6e22e">addModule</span>(<span style="color:#e6db74">&#39;sample-animation-worklet.js&#39;</span>);

<span style="color:#75715e">// 2. 获取滚动的元素和生成与之绑定的timeline对象
</span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">scrollSource</span> <span style="color:#f92672">=</span> document.<span style="color:#a6e22e">scrollingElement</span>;
<span style="color:#75715e">// 分解的动画步数
</span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">timeRange</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1000</span>;
<span style="color:#75715e">// 监听scrollSource元素的滚动事件，将行为分解成timeRange所设置的步数，可以自定义滚动的起始`startScrollOffset`和终止`endScrollOffset`偏移量
</span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">scrollTimeline</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">ScrollTimeline</span>({
  <span style="color:#a6e22e">scrollSource</span>,
  <span style="color:#a6e22e">timeRange</span>,
});

<span style="color:#75715e">// 3. 想要执行动画的元素及对应的关键帧动画效果
</span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">elem</span> <span style="color:#f92672">=</span> document.<span style="color:#a6e22e">querySelector</span>(<span style="color:#e6db74">&#39;#my-elem&#39;</span>);
<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">effectKeyframes</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">KeyframeEffect</span>(
  <span style="color:#a6e22e">elem</span>,
  <span style="color:#75715e">// 帧动画效果
</span><span style="color:#75715e"></span>  [
    {<span style="color:#a6e22e">transform</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;scale(1)&#39;</span>},
    {<span style="color:#a6e22e">transform</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;scale(.25)&#39;</span>},
    {<span style="color:#a6e22e">transform</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;scale(1)&#39;</span>}
  ],
  {
    <span style="color:#75715e">// 效果的持续时间
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// 取值 timeRange 则变化与元素滚动行为的速度保持一致
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// 取值 0-timeRange 则变化化相对滚动更快
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// 取值 &gt;timeRange 则变化相对滚动更慢
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// 取值 0 组不会执行该动画
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">duration</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">timeRange</span>,
  },
);

<span style="color:#75715e">// 创建一个WorkletAnimation实例
</span><span style="color:#75715e"></span><span style="color:#66d9ef">new</span> <span style="color:#a6e22e">WorkletAnimation</span>(
  <span style="color:#75715e">// 使用的Animation Worklet名称
</span><span style="color:#75715e"></span>  <span style="color:#e6db74">&#39;sample-animator&#39;</span>,
  <span style="color:#75715e">// 使用的帧动画效果，也可以是一个KeyframeEffect序列
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">effectKeyframes</span>,
  <span style="color:#75715e">// 使用的执行动画的timeline
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">scrollTimeline</span>,
  <span style="color:#75715e">// 传入Worklet构造器的其他参数
</span><span style="color:#75715e"></span>  {},
).<span style="color:#a6e22e">play</span>(); <span style="color:#75715e">// 创建完后执行动画
</span></code></pre></div></li>
<li>
<p>worklet部分</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#a6e22e">registerAnimator</span>(<span style="color:#e6db74">&#39;sample-animator&#39;</span>, <span style="color:#66d9ef">class</span> {
  <span style="color:#a6e22e">constructor</span>(<span style="color:#a6e22e">options</span>) {
    <span style="color:#75715e">// 在这里配置每个animator所使用的参数等
</span><span style="color:#75715e"></span>  }
  <span style="color:#a6e22e">animate</span>(<span style="color:#a6e22e">currentTime</span>, <span style="color:#a6e22e">effect</span>) {
    <span style="color:#75715e">// currentTime - timeline中定义的current time
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// effect - 正在进行的效果组
</span><span style="color:#75715e"></span>
    <span style="color:#75715e">// 在这里执行帧动画的效果逻辑
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// 通常会在这里设置动画效果的执行时间
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">effect</span>.<span style="color:#a6e22e">localTime</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">currentTime</span>;
  }
});
</code></pre></div></li>
</ol>
<h2 id="workletanimation">WorkletAnimation</h2>
<p>WorkletAnimation中包含一个Effect和一个Timeline对象，它所具有的<code>current time</code>不会直接作为动画效果发生的<a href="https://drafts.csswg.org/web-animations/#local-time-section"><code>local time</code></a>，而与其关联的Animator实例可以控制动画实际发生的<code>local time</code>。</p>
<p>下面介绍一下与WorkletAnimation相关的四个参数</p>
<ul>
<li>
<p>Animator</p>
<p>实际上是一个Animation Worklet，对动画实际发生时间进行处理，类似<code>requestAnimationFrame()</code>与<code>setTimeout()</code></p>
</li>
<li>
<p>AnimationEffect</p>
<p>用来设置关键帧动画效果，是一个KeyframeEffect实例，可以理解为CSS中@keyframe内容的JS对象体现。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">avatarEffect</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">KeyframeEffect</span>(
  document.<span style="color:#a6e22e">querySelector</span>(<span style="color:#e6db74">&#39;.avatar&#39;</span>),
  [
    {<span style="color:#a6e22e">transform</span><span style="color:#f92672">:</span> <span style="color:#e6db74">`translateY(0) scale(1)`</span>},
    {<span style="color:#a6e22e">transform</span><span style="color:#f92672">:</span> <span style="color:#e6db74">`translateY(0px) scale(</span><span style="color:#e6db74">${</span><span style="color:#ae81ff">0</span><span style="color:#e6db74">}</span><span style="color:#e6db74">)`</span>, <span style="color:#a6e22e">offset</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0</span>},
    {<span style="color:#a6e22e">transform</span><span style="color:#f92672">:</span> <span style="color:#e6db74">`translateY(</span><span style="color:#e6db74">${</span><span style="color:#ae81ff">0</span><span style="color:#e6db74">}</span><span style="color:#e6db74">px) scale(</span><span style="color:#e6db74">${</span><span style="color:#ae81ff">0</span><span style="color:#e6db74">}</span><span style="color:#e6db74">)`</span>},
  ],
  {
    <span style="color:#a6e22e">duration</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">1000</span>,
    <span style="color:#a6e22e">fill</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;both&#39;</span>,
  }
);
</code></pre></div><p>构建KeyframeEffect实例需要DOM元素、变换序列及计算的时间属性。</p>
</li>
<li>
<p>AnimationTimeline</p>
<p>提供current time的对象，在WorkletAnimation中有一个特殊的timeline概念:<code>ScrollTimeline</code>，它可以根据当前在容器中滚动的位置来决定时间值。</p>
</li>
<li>
<p>options</p>
<p>可选参数，其他需要在worklet内部使用的数据。</p>
</li>
</ul>
<h2 id="线程与时间模型">线程与时间模型</h2>
<h3 id="线程模型">线程模型</h3>
<ul>
<li>主线程执行帧动画</li>
<li>动画线程(worklet)执行animator，计算local time</li>
<li>并行的worklet执行上下文与主线程JS上下文之间动画效果值的同步，必须要在执行动画关键帧回调之前进行</li>
</ul>
<p><img src="https://wicg.github.io/animation-worklet/img/AnimationWorklet-threading-model.svg" alt=""></p>
<h3 id="时间模型">时间模型</h3>
<p>worklet animation的时间模型与web animation略有不同，具有如下特点:</p>
<ul>
<li>worklet animation在ready状态的判断中会比其他的animation多一个条件：user agent是否完成了创建worklet animation对应的animator实例所需的步骤。</li>
<li>worklet animation不会将current time作为动画效果的local time，而是交由animator实例直接处理</li>
</ul>
<p><img src="https://wicg.github.io/animation-worklet/img/WorkletAnimation-timing-model.svg" alt=""></p>
<h1 id="layout-api">Layout API</h1>
<p>CSS Layout API Level 1，简称<code>Layout API</code>，使我们可以像玩俄罗斯方块一样对页面上的元素进行布局，释放无限可能的创造力。 使用它，我们可以：</p>
<ul>
<li>真正的去操作元素的显示相关属性</li>
<li>写一个布局spec的polyfill，或者创造一个</li>
<li>创建一个不会影响性能的瀑布流布局，人见人爱</li>
</ul>
<h2 id="基本概念">基本概念</h2>
<ul>
<li>
<p>Current Layout</p>
<p>表示在当前盒模型中执行的布局算法</p>
</li>
<li>
<p>Parent Layout</p>
<p>作为执行布局算法的父级元素，会应用形如<code>display: layout(custom)</code>的计算属性，加载layout worklet中的布局算法。执行了布局算法后的父级元素布局即为<code>Parent Layout</code></p>
</li>
<li>
<p>Layout Edges</p>
<p>在<code>Parent Layout</code>中包含的边框、内边距与滚动条等属性，都被收集在了<code>Layout Edges</code>中</p>
</li>
<li>
<p>Layout Constraint</p>
<p>在<code>Parent Layout</code>中移除掉<code>Layout Edges</code>，剩下用来布局子元素的区域叫做<code>Layout Constraint</code></p>
</li>
<li>
<p>Child Layout</p>
<p><code>Child Layout</code>表示<code>Current Layout</code>中<code>Layout Child</code>的布局算法</p>
</li>
<li>
<p>LayoutChild</p>
<p><code>LayoutChild</code>是一个用来内部计算的容器，本身不具有布局信息，只能通过<code>确定条件</code>生成，可以被用来生成实际执行布局的<code>Fragment</code></p>
</li>
<li>
<p>Fragment</p>
<p>用来执行具体布局算法的元素</p>
</li>
</ul>
<p><img src="http://houdini.glitch.me/layout/layout.svg" alt=""></p>
<h2 id="如何使用-4">如何使用</h2>
<ol>
<li>
<p>CSS部分</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-css" data-lang="css">.<span style="color:#a6e22e">some-element</span> {
  <span style="color:#66d9ef">display</span>: <span style="color:#a6e22e">layout</span>(custom);
}
</code></pre></div><p>在目标元素的display属性上使用<code>layout()</code>计算属性加载自定义的layout模块</p>
</li>
<li>
<p>JS部分</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#a6e22e">CSS</span>.<span style="color:#a6e22e">layoutWorklet</span>.<span style="color:#a6e22e">addModule</span>(<span style="color:#e6db74">&#39;customLayout.js&#39;</span>);
</code></pre></div></li>
<li>
<p>worklet部分</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#75715e">// customLayout.js
</span><span style="color:#75715e"></span><span style="color:#a6e22e">registerLayout</span>(<span style="color:#e6db74">&#39;custom&#39;</span>, <span style="color:#66d9ef">class</span> {
  <span style="color:#75715e">// 传入样式属性与配置选项
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">static</span> <span style="color:#a6e22e">inputProperties</span> <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;--foo&#39;</span>];
  <span style="color:#66d9ef">static</span> <span style="color:#a6e22e">childrenInputProperties</span> <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;--bar&#39;</span>];
  <span style="color:#66d9ef">static</span> <span style="color:#a6e22e">layoutOptions</span> <span style="color:#f92672">=</span> {
    <span style="color:#a6e22e">childDisplay</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;normal&#39;</span>,
    <span style="color:#a6e22e">sizing</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;block-like&#39;</span>
  };

  <span style="color:#a6e22e">async</span> <span style="color:#a6e22e">intrinsicSizes</span>(<span style="color:#a6e22e">children</span>, <span style="color:#a6e22e">edges</span>, <span style="color:#a6e22e">styleMap</span>) {
    <span style="color:#75715e">// 在这里计算固有尺寸
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">childIntrinsicSize</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">await</span> <span style="color:#a6e22e">children</span>[<span style="color:#ae81ff">0</span>].<span style="color:#a6e22e">intrinsicSizes</span>();
  }

  <span style="color:#a6e22e">async</span> <span style="color:#a6e22e">layout</span>(<span style="color:#a6e22e">children</span>, <span style="color:#a6e22e">edges</span>, <span style="color:#a6e22e">constraints</span>, <span style="color:#a6e22e">styleMap</span>, <span style="color:#a6e22e">breakToken</span>) {
    <span style="color:#75715e">// 在这里执行布局代码&amp;算法
</span><span style="color:#75715e"></span>
    <span style="color:#75715e">// 在intrinsicSizes与layout函数中均会传入children列表
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">child</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">children</span>[<span style="color:#ae81ff">0</span>];

    <span style="color:#75715e">// 获取childInputProperties中列举的属性
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">fooValue</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">child</span>.<span style="color:#a6e22e">styleMap</span>.<span style="color:#a6e22e">get</span>(<span style="color:#e6db74">&#39;--foo&#39;</span>);

    <span style="color:#75715e">// layoutNextFragment函数用来生成frament，执行布局
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">fragment</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">await</span> <span style="color:#a6e22e">child</span>.<span style="color:#a6e22e">layoutNextFragment</span>({});
  }
});
</code></pre></div></li>
</ol>
<h2 id="layout-worklet">Layout Worklet</h2>
<p>简要介绍Layout Worklet中的主要配置选项与函数</p>
<ul>
<li>
<p><code>inputProperties</code>与<code>childrenInputProperties</code></p>
<p>每个Layout API容器均有一个<code>styleMap</code>对象，在<code>inputProperties</code>中可以设置从<code>styleMap</code>中可读取的属性，该属性可以是css属性也可以是自定义属性，如<code>margin-top</code>, <code>padding</code>, <code>--foo</code>等。子元素的styleMap可访问属性需要在<code>childrenInputProperties</code>中定义</p>
</li>
<li>
<p><code>layoutOptions</code></p>
<p>设置布局选项，包含<code>childDisplay</code>和<code>sizing</code>属性。其中sizing的取值有两种：<code>block-like(默认)</code>与<code>manual</code>，前者表示应用盒容器的尺寸特性，后者表示尺寸由开发者指定</p>
</li>
<li>
<p><code>layout()</code></p>
<p>该函数包含五个参数: <code>children</code>, <code>edges</code>, <code>constraints</code>, <code>styleMap</code>和<code>breakToken</code></p>
<ul>
<li><code>children</code> ([LayoutChild]) - 表示Parent中的LayoutChild列表</li>
<li><code>edges</code> (LayoutEdges) - 包含盒模型的所有边界距内容的距离值，如<code>inlineStart</code>, <code>blockEnd</code>等，这里的inline和block指的是根据<code>writing-mode</code>值所确定的排列方向。</li>
<li><code>constraints</code> (LayoutConstraints) - 包含父级元素布局区域的各种尺寸，如<code>fixedInlineSize</code>, <code>availableBlockSize</code>等</li>
<li><code>styleMap</code> (StylePropertyMapReadOnly) - 一个包含自定义属性与样式属性的只读Map，属性在<code>inputProperties</code>中导入</li>
<li><code>breakToken</code> - <a href="https://drafts.css-houdini.org/css-layout-api/#childbreaktoken">Spec中的说明</a>(实际测试中未发现该参数，也许是笔者姿势不对..)</li>
</ul>
</li>
<li>
<p><code>intrinsicSizes()</code></p>
<p>该函数中会传入三个参数: <code>children</code>, <code>edges</code>, <code>styleMap</code>。可以通过<code>children</code>中LayoutChild的<code>intrinsicSizes()</code>方法获取所有子元素的固有尺寸，在此基础上可以结合其他两种参数计算并返回该current layout中的固有尺寸。<code>intrinsicSizes</code>对象包含<code>minContentSize</code>和<code>maxContentSize</code>两种属性</p>
</li>
</ul>
<h1 id="其他">其他</h1>
<h2 id="demo">Demo</h2>
<p>GoogleChromeLabs的Houdini API相关示例:</p>
<p><a href="https://googlechromelabs.github.io/houdini-samples/">https://googlechromelabs.github.io/houdini-samples/</a></p>
<p>一些Paint API示例:</p>
<p><a href="https://github.com/gagyibenedek/paint-api-examples">https://github.com/gagyibenedek/paint-api-examples</a></p>
<h2 id="支持情况检测">支持情况检测</h2>
<p>以<code>Paint API</code>为例</p>
<p><strong>JS中检测</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#66d9ef">if</span> (<span style="color:#e6db74">&#39;paintWorklet&#39;</span> <span style="color:#66d9ef">in</span> <span style="color:#a6e22e">CSS</span>) {
  <span style="color:#a6e22e">CSS</span>.<span style="color:#a6e22e">paintWorklet</span>.<span style="color:#a6e22e">addModule</span>(<span style="color:#e6db74">&#39;paintWorklet.js&#39;</span>);
}
</code></pre></div><p><strong>CSS中检测</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-css" data-lang="css">@<span style="color:#66d9ef">supports</span> <span style="color:#f92672">(</span><span style="color:#f92672">background</span><span style="color:#f92672">:</span> <span style="color:#f92672">paint</span><span style="color:#f92672">(</span><span style="color:#f92672">id</span><span style="color:#f92672">))</span> {
  <span style="color:#75715e">/* ... */</span>
}
</code></pre></div><h1 id="总结">总结</h1>
<p>介绍完了这些CSS Houdini API后，相信已经对它们有了一个比较系统的了解。期待它们在主流浏览器上的实现，并看看它带来的这些可能性怎么供广大开发者施展拳脚，拭目以待~</p>
<h1 id="参考">参考</h1>
<ul>
<li><a href="https://drafts.css-houdini.org/">CSS-TAG Houdini Editor Drafts</a></li>
<li><a href="http://houdini.glitch.me">Houdini Spellbook</a></li>
<li><a href="https://css-tricks.com/the-css-paint-api/">The CSS Paint API | CSS-Tricks</a></li>
<li><a href="https://blog.logrocket.com/new-horizons-in-css-houdini-and-the-paint-api-8b307cf387bb">New horizons in CSS: Houdini and the Paint API</a></li>
<li><a href="https://developers.google.com/web/updates/2018/01/paintapi">CSS Paint API | Web | Google Developers</a></li>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Animations_API/Using_the_Web_Animations_API">Using the Web Animations API</a></li>
<li><a href="https://github.com/GoogleChromeLabs/houdini-samples">GoogleChromeLabs/houdini-samples: Demos for different Houdini APIs</a></li>
</ul>
<!-- raw HTML omitted -->
        </div>

        
<div class="post-archive">
    <ul class="post-copyright">
        <li><strong>原文作者：</strong><a rel="author" href="http://yrq110.me/">yrq110</a></li>
        <li style="word-break:break-all"><strong>原文链接：</strong><a href="http://yrq110.me/post/front-end/try-houdini-api/">http://yrq110.me/post/front-end/try-houdini-api/</a></li>
        <li><strong>版权声明：</strong>本作品采用<a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/4.0/">知识共享署名-非商业性使用-禁止演绎 4.0 国际许可协议</a>进行许可，非商业转载请注明出处（作者，原文链接），商业转载请联系作者获得授权。</li>
    </ul>
</div>
<br/>



        

<div class="post-archive">
    <h2>See Also</h2>
    <ul class="listing">
        
        <li><a href="/post/practice/calathus/">前端水果篮</a></li>
        
        <li><a href="/post/practice/css-secret-note/">《CSS揭秘》示例练习</a></li>
        
    </ul>
</div>


        <div class="post-meta meta-tags">
            
            <ul class="clearfix">
                
                <li><a href='http://yrq110.me/tags/houdini'>houdini</a></li>
                
                <li><a href='http://yrq110.me/tags/css'>css</a></li>
                
            </ul>
            
        </div>
    </article>
    
    

    
    
    <div class="post bg-white">
      <script src="https://utteranc.es/client.js"
            repo= "yrq110/blog-comments"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
      </script>
    </div>
    
</div>

                </div>

                <div id="secondary">
    <section class="widget">
        <form id="search" action='//www.google.com/search' method="get" accept-charset="utf-8" target="_blank" _lpchecked="1">
      
      <input type="text" name="q" maxlength="20" placeholder="Search">
      <input type="hidden" name="sitesearch" value="http://yrq110.me/">
      <button type="submit" class="submit icon-search"></button>
</form>
    </section>
    
    <section class="widget">
        <h3 class="widget-title">最近文章</h3>
<ul class="widget-list">
    
    <li>
        <a href="http://yrq110.me/post/front-end/dive-into-playwright/" title="跨平台的浏览器自动化工具Playwright简析">跨平台的浏览器自动化工具Playwright简析</a>
    </li>
    
    <li>
        <a href="http://yrq110.me/post/front-end/best-practice-of-typescript-in-webapp-developing/" title="使用TypeScript开发Web应用的最佳实践">使用TypeScript开发Web应用的最佳实践</a>
    </li>
    
    <li>
        <a href="http://yrq110.me/post/front-end/multi-ways-to-draw-graphic-primitives-in-web/" title="Web中茴香豆的几种画法">Web中茴香豆的几种画法</a>
    </li>
    
    <li>
        <a href="http://yrq110.me/post/front-end/dive-into-2d-canvas-framework-iii-pixi/" title="Canvas2D渲染库简析:（三）Pixi">Canvas2D渲染库简析:（三）Pixi</a>
    </li>
    
    <li>
        <a href="http://yrq110.me/post/front-end/dive-into-2d-canvas-framework-ii-konva/" title="Canvas2D渲染库简析:（二）Konva">Canvas2D渲染库简析:（二）Konva</a>
    </li>
    
    <li>
        <a href="http://yrq110.me/post/front-end/dive-into-2d-canvas-framework-i-fabric/" title="Canvas2D渲染库简析:（一）Fabric">Canvas2D渲染库简析:（一）Fabric</a>
    </li>
    
    <li>
        <a href="http://yrq110.me/post/front-end/practice-in-e2e-test-with-puppeteer/" title="Puppeteer&#43;Canvas的E2E测试实践">Puppeteer&#43;Canvas的E2E测试实践</a>
    </li>
    
    <li>
        <a href="http://yrq110.me/post/devops/how-lerna-manage-package-dependencies/" title="Lerna的依赖管理及hoisting浅析">Lerna的依赖管理及hoisting浅析</a>
    </li>
    
    <li>
        <a href="http://yrq110.me/post/front-end/chromium-rendering-pipeline-step-by-step/" title="一个像素的一生 - 剖析Chromium渲染流水线">一个像素的一生 - 剖析Chromium渲染流水线</a>
    </li>
    
    <li>
        <a href="http://yrq110.me/post/front-end/try-gpu-operations-in-web/" title="Web也要在GPU并行计算中分一杯羹？">Web也要在GPU并行计算中分一杯羹？</a>
    </li>
    
</ul>
    </section>

    

    <section class="widget">
        <h3 class="widget-title">分类</h3>
<ul class="widget-list">
    
    <li><a href="http://yrq110.me/categories/database/">database (2)</a></li>
    
    <li><a href="http://yrq110.me/categories/devops/">devops (5)</a></li>
    
    <li><a href="http://yrq110.me/categories/front-end/">front-end (18)</a></li>
    
    <li><a href="http://yrq110.me/categories/go/">go (1)</a></li>
    
    <li><a href="http://yrq110.me/categories/practice/">practice (2)</a></li>
    
</ul>
    </section>

    <section class="widget">
        <h3 class="widget-title">标签</h3>
<div class="tagcloud">
    
    <a href="http://yrq110.me/tags/blink/">blink</a>
    
    <a href="http://yrq110.me/tags/canvas/">canvas</a>
    
    <a href="http://yrq110.me/tags/chrome/">chrome</a>
    
    <a href="http://yrq110.me/tags/chromium/">chromium</a>
    
    <a href="http://yrq110.me/tags/css/">css</a>
    
    <a href="http://yrq110.me/tags/docker/">docker</a>
    
    <a href="http://yrq110.me/tags/dom/">dom</a>
    
    <a href="http://yrq110.me/tags/e2e/">e2e</a>
    
    <a href="http://yrq110.me/tags/electron/">electron</a>
    
    <a href="http://yrq110.me/tags/event-loop/">event-loop</a>
    
    <a href="http://yrq110.me/tags/fabric/">fabric</a>
    
    <a href="http://yrq110.me/tags/git/">git</a>
    
    <a href="http://yrq110.me/tags/git-submodule/">git-submodule</a>
    
    <a href="http://yrq110.me/tags/github/">github</a>
    
    <a href="http://yrq110.me/tags/gpu/">gpu</a>
    
    <a href="http://yrq110.me/tags/houdini/">houdini</a>
    
    <a href="http://yrq110.me/tags/hugo/">hugo</a>
    
    <a href="http://yrq110.me/tags/konva/">konva</a>
    
    <a href="http://yrq110.me/tags/lerna/">lerna</a>
    
    <a href="http://yrq110.me/tags/libuv/">libuv</a>
    
    <a href="http://yrq110.me/tags/maupassant/">maupassant</a>
    
    <a href="http://yrq110.me/tags/mongo/">mongo</a>
    
    <a href="http://yrq110.me/tags/mpvue/">mpvue</a>
    
    <a href="http://yrq110.me/tags/node/">node</a>
    
    <a href="http://yrq110.me/tags/offscreen-canvas/">offscreen canvas</a>
    
    <a href="http://yrq110.me/tags/pixi/">pixi</a>
    
    <a href="http://yrq110.me/tags/playwright/">playwright</a>
    
    <a href="http://yrq110.me/tags/puppeteer/">puppeteer</a>
    
    <a href="http://yrq110.me/tags/rendering-pipeline/">rendering pipeline</a>
    
    <a href="http://yrq110.me/tags/skia/">skia</a>
    
    <a href="http://yrq110.me/tags/ssh/">ssh</a>
    
    <a href="http://yrq110.me/tags/svg/">svg</a>
    
    <a href="http://yrq110.me/tags/typescript/">typescript</a>
    
    <a href="http://yrq110.me/tags/vue/">vue</a>
    
    <a href="http://yrq110.me/tags/web-worker/">web worker</a>
    
    <a href="http://yrq110.me/tags/webgl/">webgl</a>
    
    <a href="http://yrq110.me/tags/webgpu/">webgpu</a>
    
    <a href="http://yrq110.me/tags/websocket/">websocket</a>
    
    <a href="http://yrq110.me/tags/wxapp/">wxapp</a>
    
    <a href="http://yrq110.me/tags/yarn/">yarn</a>
    
</div>
    </section>

    
<section class="widget">
    <h3 class="widget-title">友情链接</h3>
    <ul class="widget-list">
        
        <li>
            <a target="_blank" href="https://taoyuan.fun/" title="taoyuan">taoyuan</a>
        </li>
        
        <li>
            <a target="_blank" href="https://blog.cshayne.cn/" title="cshayne">cshayne</a>
        </li>
        
    </ul>
</section>


    <section class="widget">
        <h3 class="widget-title">其它</h3>
        <ul class="widget-list">
            <li><a href="http://yrq110.me/index.xml">文章 RSS</a></li>
        </ul>
    </section>
</div>
            </div>
        </div>
    </div>
    <footer id="footer">
    <div class="container">
        &copy; 2020 <a href="http://yrq110.me/">￥ЯႭ1I0 By yrq110</a>.
        Powered by <a rel="nofollow noreferer noopener" href="https://gohugo.io" target="_blank">Hugo</a>.
        <a href="https://www.flysnow.org/" target="_blank">Theme</a> based on <a href="https://github.com/flysnow-org/maupassant-hugo" target="_blank">maupassant</a>.
        
    </div>
</footer>


    
    <script type="text/javascript">
        window.MathJax = {
            tex2jax: {
                inlineMath: [['$', '$']],
                processEscapes: true
                }
            };
    </script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML' async></script>


<a id="rocket" href="#top"></a>
<script type="text/javascript" src='/js/totop.js?v=0.0.0' async=""></script>

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-131471642-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>






</body>

</html>