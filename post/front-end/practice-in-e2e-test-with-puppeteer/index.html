<!doctype html>
<html lang="zh-CN">
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    

    <title>Puppeteer&#43;Canvas的E2E测试实践 | ￥ЯႭ1I0</title>
    <meta property="og:title" content="Puppeteer&#43;Canvas的E2E测试实践 - ￥ЯႭ1I0">
    <meta property="og:type" content="article">
        
    <meta property="article:published_time" content='2019-12-17T14:14:30&#43;08:00'>
        
        
    <meta property="article:modified_time" content='2019-12-17T14:14:30&#43;08:00'>
        
    <meta name="Keywords" content="">
    <meta name="description" content="Puppeteer&#43;Canvas的E2E测试实践">
        
    <meta name="author" content="yrq110">
    <meta property="og:url" content="http://yrq110.me/post/front-end/practice-in-e2e-test-with-puppeteer/">
    <link rel="shortcut icon" href='/favicon.ico'  type="image/x-icon">

    <link rel="stylesheet" href='/css/normalize.css'>
    <link rel="stylesheet" href='/css/style.css'>
    <script type="text/javascript" src="//cdn.bootcdn.net/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

    
    
    
    
    
    
</head>


<body>
    <header id="header" class="clearfix">
    <div class="container">
        <div class="col-group">
            <div class="site-name ">
                
                    <a id="logo" href="http://yrq110.me/">
                        ￥ЯႭ1I0
                    </a>
                
                
            </div>
            <div>
                <nav id="nav-menu" class="clearfix">
                    <a class="current" href="http://yrq110.me/">首页</a>
                    
                    <a  href="http://yrq110.me/archives/" title="归档">归档</a>
                    
                    <a  href="http://yrq110.me/about/" title="关于">关于</a>
                    
                </nav>
            </div>
        </div>
    </div>
</header>

    <div id="body">
        <div class="container">
            <div class="col-group">

                <div class="col-8" id="main">
                    
<div class="res-cons">
    
    <article class="post">
        <header>
            <h1 class="post-title">Puppeteer&#43;Canvas的E2E测试实践</h1>
        </header>
        <date class="post-meta meta-date">
            2019年12月17日
        </date>
        
        <div class="post-meta">
            <span>|</span>
            
            <span class="meta-category"><a href='/categories/front-end'>front-end</a></span>
            
        </div>
        
        
        
        <div class="post-content">
            <p>针对具有复杂canvas交互操作的e2e测试，尝试使用puppeteer模拟复杂canvas交互，自动执行相关测试用例，利于减少重复的人工验证和回归测试。</p>
<p>主要做了<strong>封装通用操作</strong>，<strong>添加操作辅助类</strong>，<strong>与测试工具集成</strong>，<strong>结果验证</strong>等工作。</p>
<h2 id="为何使用puppeteer模拟canvas上的操作">为何使用puppeteer模拟canvas上的操作</h2>
<p>前端不乏比较优秀的e2e测试框架，比如<a href="https://www.cypress.io/">cypress</a>和<a href="https://nightwatchjs.org/">nightwatch</a>等等，他们均具有较完整的相关工具集和API，如browser driver、断言等等。</p>
<p>他们操纵浏览器的方式，即driver的实现方式主要有两种：</p>
<ol>
<li><strong>通过WebDriver远程调用</strong>，通过协议与HTTP通信给内置driver传递指令来指挥浏览器执行操作，如nightwatch, selenium等</li>
<li><strong>在浏览器内部执行操作</strong>，通过使用dom元素上的API执行相关操作，如cypress等</li>
</ol>
<p><strong>这些框架不怎么适用于测试canvas上的复杂交互，问题就来自于他们的driver，不支持更加细粒度的鼠标操作</strong>。</p>
<p>在第一种方式中，driver的能力受限于<a href="https://www.w3.org/TR/webdriver"><strong>WebDriver标准</strong></a>中的定义。可以参考WebDrier标准中有关<a href="https://www.w3.org/TR/webdriver/#interaction">元素交互</a>的部分，具有如下条目：</p>
<pre><code>* 12.4 Interaction
  * 12.4.1 Element Click
  * 12.4.2 Element Clear
  * 12.4.3 Element Send Keys
</code></pre><p>即元素的点击、可编辑元素的清空和发送按键指令。</p>
<p>而在第二种方式中，driver的能力受限于<strong>DOM API</strong>。可以在cypress自己实现的内置driver中看到它所拥有的<a href="https://github.com/cypress-io/cypress/tree/develop/packages/driver/src/cy/commands/actions">actions</a>：</p>
<pre><code>* check
* click
* focus
* scroll
* type
...
</code></pre><p>以scroll操作为例，内部直接调用的scrollTo方法：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">https</span><span style="color:#f92672">:</span><span style="color:#75715e">//github.com/cypress-io/cypress/blob/develop/packages/driver/src/cy/commands/actions/scroll.coffee
</span><span style="color:#75715e"></span><span style="color:#a6e22e">$</span>(<span style="color:#a6e22e">options</span>.<span style="color:#a6e22e">$parent</span>).<span style="color:#a6e22e">scrollTo</span>(<span style="color:#a6e22e">options</span>.<span style="color:#a6e22e">$el</span>, {
  <span style="color:#a6e22e">axis</span><span style="color:#f92672">:</span>     <span style="color:#a6e22e">options</span>.<span style="color:#a6e22e">axis</span>
  <span style="color:#a6e22e">easing</span><span style="color:#f92672">:</span>   <span style="color:#a6e22e">options</span>.<span style="color:#a6e22e">easing</span>
  <span style="color:#a6e22e">duration</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">options</span>.<span style="color:#a6e22e">duration</span>
  <span style="color:#a6e22e">offset</span><span style="color:#f92672">:</span>   <span style="color:#a6e22e">options</span>.<span style="color:#a6e22e">offset</span>
  <span style="color:#a6e22e">done</span><span style="color:#f92672">:</span> (<span style="color:#a6e22e">animation</span>, <span style="color:#a6e22e">jumpedToEnd</span>) <span style="color:#f92672">-&gt;</span>
    <span style="color:#a6e22e">resolve</span>(<span style="color:#a6e22e">options</span>.<span style="color:#a6e22e">$el</span>)
  <span style="color:#a6e22e">fail</span><span style="color:#f92672">:</span> (<span style="color:#a6e22e">animation</span>, <span style="color:#a6e22e">jumpedToEnd</span>) <span style="color:#f92672">-&gt;</span>
    <span style="color:#960050;background-color:#1e0010">##</span> <span style="color:#a6e22e">its</span> Promise <span style="color:#a6e22e">object</span> <span style="color:#a6e22e">is</span> <span style="color:#a6e22e">rejected</span>
    <span style="color:#66d9ef">try</span>
      <span style="color:#a6e22e">$utils</span>.<span style="color:#a6e22e">throwErrByPath</span>(<span style="color:#e6db74">&#34;scrollTo.animation_failed&#34;</span>)
    <span style="color:#66d9ef">catch</span> <span style="color:#a6e22e">err</span>
      <span style="color:#a6e22e">reject</span>(<span style="color:#a6e22e">err</span>)
  <span style="color:#a6e22e">always</span><span style="color:#f92672">:</span> <span style="color:#f92672">-&gt;</span>
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">parentIsWin</span>
      <span style="color:#66d9ef">delete</span> <span style="color:#a6e22e">options</span>.<span style="color:#a6e22e">$parent</span>.<span style="color:#a6e22e">contentWindow</span>
})
</code></pre></div><p>介绍完测试框架中已有的两种driver，再来看看puppeteer中是如何做的。</p>
<p>puppeteer(/ˌpəpəˈtir/，以下简称pptr)是一个通过<strong>CDP(Chrome Devtools Protocol)和websocket</strong>实现与chromium实例交互的Node顶层API。
可以使用它提供的API来操作浏览器实例，在<a href="https://yrq110.me/post/front-end/swim-in-shallow-puppeteer-api/">之前</a>的文中有简单介绍，还可以看看官方的一些<a href="https://github.com/puppeteer/examples">例子</a>。</p>
<p>pptr并没有使用上面的两种driver，而是通过实现一个遵循CDP的Node端应用来操作浏览器，内部分别使用CDPSession与FrameManager来管理网络与页面。</p>
<p>CDP提供了大量细粒度的操作类型与选项，而pptr充分利用了这些，在pptr中提供的API可以满足复杂canvas交互中所需的键鼠模拟操作。</p>
<p>现在有一个canvas，可以在上面进行笔画绘制的操作：</p>
<!-- raw HTML omitted -->
<p>如果要模拟这个操作，需要实现：</p>
<ol>
<li>单独控制控制鼠标按键的按下和抬起，实现拖拽效果</li>
<li>根据位置坐标控制光标移动，绘制一段线段或曲线</li>
</ol>
<p>pptr中的Mouse类所提供的方法就可以满足上述要求，如下：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#66d9ef">await</span> <span style="color:#a6e22e">page</span>.<span style="color:#a6e22e">mouse</span>.<span style="color:#a6e22e">move</span>(...<span style="color:#a6e22e">start</span>);
<span style="color:#66d9ef">await</span> <span style="color:#a6e22e">page</span>.<span style="color:#a6e22e">mouse</span>.<span style="color:#a6e22e">down</span>();
<span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">points</span>.<span style="color:#a6e22e">length</span> <span style="color:#f92672">/</span> <span style="color:#ae81ff">2</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>) {
  <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">page</span>.<span style="color:#a6e22e">waitFor</span>(<span style="color:#ae81ff">200</span>);
  <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">page</span>.<span style="color:#a6e22e">mouse</span>.<span style="color:#a6e22e">move</span>(<span style="color:#a6e22e">points</span>[<span style="color:#a6e22e">i</span><span style="color:#f92672">*</span><span style="color:#ae81ff">2</span>], <span style="color:#a6e22e">points</span>[<span style="color:#a6e22e">i</span><span style="color:#f92672">*</span><span style="color:#ae81ff">2</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>);
}
<span style="color:#66d9ef">await</span> <span style="color:#a6e22e">page</span>.<span style="color:#a6e22e">mouse</span>.<span style="color:#a6e22e">up</span>();
</code></pre></div><p>若仅使用pptr测试少量复杂交互的话单独编写几个方法即可，如果要与测试工具集成的话就需要额外做一些工作了。</p>
<h2 id="封装常用操作">封装常用操作</h2>
<p>首先，处理一些项目中测试集的常用操作，包含初始化页面、双击等通用操作和指定路径拖拽和登录组件登录等业务中的常用操作，下面是两个示例。</p>
<p>初始化页面：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">initPage</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">async</span> (<span style="color:#a6e22e">url</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">string</span>, <span style="color:#a6e22e">config</span><span style="color:#f92672">:</span> Object)<span style="color:#f92672">:</span> Promise<span style="color:#f92672">&lt;</span><span style="color:#a6e22e">Page</span><span style="color:#f92672">&gt;</span> =&gt; {
  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">launchOption</span> <span style="color:#f92672">=</span> Object.<span style="color:#a6e22e">assign</span>({}, <span style="color:#a6e22e">BROWSER_CONFIG</span>.<span style="color:#a6e22e">LaunchOption</span>, <span style="color:#a6e22e">config</span>);
  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">browser</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">pptr</span>.<span style="color:#a6e22e">launch</span>(<span style="color:#a6e22e">launchOption</span>);
  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">page</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">browser</span>.<span style="color:#a6e22e">newPage</span>();
  <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">page</span>.<span style="color:#66d9ef">goto</span>(<span style="color:#a6e22e">url</span>);
  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">page</span>
}
</code></pre></div><p>按照传入路径执行鼠标移动操作：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">dragByRoute</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">async</span> (<span style="color:#a6e22e">page</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">Page</span>, <span style="color:#a6e22e">routes</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">Route</span>, <span style="color:#a6e22e">isClose</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">boolean</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>, <span style="color:#a6e22e">delay</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">number</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">200</span>)<span style="color:#f92672">:</span> Promise<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">void</span><span style="color:#f92672">&gt;</span> =&gt; {
  <span style="color:#66d9ef">const</span> [<span style="color:#a6e22e">start</span>, ...<span style="color:#a6e22e">points</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">routes</span>;
  <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">page</span>.<span style="color:#a6e22e">mouse</span>.<span style="color:#a6e22e">move</span>(...<span style="color:#a6e22e">start</span>);
  <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">page</span>.<span style="color:#a6e22e">mouse</span>.<span style="color:#a6e22e">down</span>();
  <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">page</span>.<span style="color:#a6e22e">mouse</span>.<span style="color:#a6e22e">move</span>(<span style="color:#a6e22e">start</span>[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>, <span style="color:#a6e22e">start</span>[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>); <span style="color:#75715e">// hack to trigger mousemove event
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">points</span>.<span style="color:#a6e22e">length</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>) {
    <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">page</span>.<span style="color:#a6e22e">waitFor</span>(<span style="color:#a6e22e">delay</span>);
    <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">page</span>.<span style="color:#a6e22e">mouse</span>.<span style="color:#a6e22e">move</span>(<span style="color:#a6e22e">points</span>[<span style="color:#a6e22e">i</span>][<span style="color:#ae81ff">0</span>], <span style="color:#a6e22e">points</span>[<span style="color:#a6e22e">i</span>][<span style="color:#ae81ff">1</span>]);
  }
  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">isClose</span>) {
    <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">page</span>.<span style="color:#a6e22e">waitFor</span>(<span style="color:#a6e22e">delay</span>);
    <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">page</span>.<span style="color:#a6e22e">mouse</span>.<span style="color:#a6e22e">move</span>(<span style="color:#a6e22e">start</span>[<span style="color:#ae81ff">0</span>], <span style="color:#a6e22e">start</span>[<span style="color:#ae81ff">1</span>]);
  }
  <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">page</span>.<span style="color:#a6e22e">waitFor</span>(<span style="color:#a6e22e">delay</span>);
  <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">page</span>.<span style="color:#a6e22e">mouse</span>.<span style="color:#a6e22e">up</span>();
};
</code></pre></div><h2 id="添加操作辅助类">添加操作辅助类</h2>
<p>封装好常用操作后，在编写实际的用例集之前，需要再引入一个操作辅助类。</p>
<p>这个辅助类主要有两个作用：</p>
<ol>
<li>
<p>收集错误及对应的操作描述信息，方便debug</p>
<p>若单纯的让测试工具抛出异常，那么找不到选择器元素这类的错误很难定义到具体的操作</p>
</li>
<li>
<p>在调用时为操作添加说明，方便协作与修改</p>
<p>在编写完操作流程后，若其他人对交互不甚熟悉，单单看代码中某个点击或移动的操作会一头雾水，并不知道这些操作的含义</p>
</li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#75715e">// refs to alex&#39;s blog[1]
</span><span style="color:#75715e"></span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">default</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ActionStack</span> {
  <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">actionsSoFar</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">string</span>[];
  <span style="color:#a6e22e">constructor</span>() {
    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">actionsSoFar</span> <span style="color:#f92672">=</span> [];
  }
  <span style="color:#66d9ef">async</span> <span style="color:#a6e22e">executeAction</span>(<span style="color:#a6e22e">actionDescription</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">string</span>, <span style="color:#a6e22e">action</span><span style="color:#f92672">:</span> Function) {
    <span style="color:#66d9ef">try</span> {
      <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">actionsSoFar</span>.<span style="color:#a6e22e">push</span>(<span style="color:#a6e22e">actionDescription</span>);
      <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">action</span>();
    } <span style="color:#66d9ef">catch</span> (<span style="color:#a6e22e">e</span>) {
      <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">actionsSoFar</span>.<span style="color:#a6e22e">pop</span>();
      <span style="color:#75715e">// bind error msg to specific action
</span><span style="color:#75715e"></span>      <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">errorMessage</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">`Failed during action &#34;</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">actionDescription</span><span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;, due to error: </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">e</span><span style="color:#e6db74">}</span><span style="color:#e6db74">\n`</span>;
      <span style="color:#a6e22e">errorMessage</span> <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#39;Actions leading up to failure:\n&#39;</span>;
      <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">actionsSoFar</span>.<span style="color:#a6e22e">length</span> <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">3</span> <span style="color:#f92672">?</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">actionsSoFar</span>.<span style="color:#a6e22e">length</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">3</span> <span style="color:#f92672">:</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">actionsSoFar</span>.<span style="color:#a6e22e">length</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>) {
        <span style="color:#a6e22e">errorMessage</span> <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#39;&#34;&#39;</span> <span style="color:#f92672">+</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">actionsSoFar</span>[<span style="color:#a6e22e">i</span>] <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;&#34;\n&#39;</span>;
      }
      <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> Error(<span style="color:#a6e22e">errorMessage</span>);
    }
    }
  }
}
</code></pre></div><p>使用时：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">as</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">ActionStack</span>();
<span style="color:#75715e">// ...
</span><span style="color:#75715e"></span><span style="color:#66d9ef">await</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">as</span>.<span style="color:#a6e22e">executeAction</span>(<span style="color:#e6db74">&#39;Remove a path point&#39;</span>, <span style="color:#66d9ef">async</span> () =&gt; {
  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">del</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">points</span>[<span style="color:#ae81ff">0</span>];
  <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">page</span>.<span style="color:#a6e22e">waitFor</span>(<span style="color:#ae81ff">500</span>);
  <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">page</span>.<span style="color:#a6e22e">mouse</span>.<span style="color:#a6e22e">move</span>(<span style="color:#a6e22e">del</span>[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">+</span> <span style="color:#ae81ff">3</span>, <span style="color:#a6e22e">del</span>[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">+</span> <span style="color:#ae81ff">3</span>);
  <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">page</span>.<span style="color:#a6e22e">waitFor</span>(<span style="color:#ae81ff">500</span>);
  <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">page</span>.<span style="color:#a6e22e">mouse</span>.<span style="color:#a6e22e">click</span>(<span style="color:#a6e22e">del</span>[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">+</span> <span style="color:#ae81ff">12</span>, <span style="color:#a6e22e">del</span>[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">-</span> <span style="color:#ae81ff">20</span>);
  <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">page</span>.<span style="color:#a6e22e">waitFor</span>(<span style="color:#ae81ff">3000</span>);
});
</code></pre></div><h2 id="添加用例runner">添加用例Runner</h2>
<p>创建一个基类Runner和针对不同类型用例操作的Runner</p>
<p>在BaseRunner中声明Page对象，处理部分初始化与资源释放等操作</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">default</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">BaseRunner</span> <span style="color:#66d9ef">implements</span> <span style="color:#a6e22e">IBaseRunner</span>{
  <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">address</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">string</span>;
  <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">config</span><span style="color:#f92672">?:</span> <span style="color:#a6e22e">object</span>;
  <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">page</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">Page</span>;

  <span style="color:#a6e22e">constructor</span>(<span style="color:#a6e22e">address</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">string</span>, <span style="color:#a6e22e">config</span><span style="color:#f92672">?:</span> <span style="color:#a6e22e">object</span>) {
    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">address</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">address</span>;
    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">config</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">config</span> <span style="color:#f92672">||</span> {};
  }

  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">async</span> <span style="color:#a6e22e">prepose</span>() {
    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">page</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">initPage</span>(<span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">address</span>, <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">config</span>);
    <span style="color:#75715e">// 其他处理...
</span><span style="color:#75715e"></span>  }

  <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">dispose</span>() {
    <span style="color:#75715e">// 释放资源...
</span><span style="color:#75715e"></span>  }
}
</code></pre></div><p>在用例集相关的Runner中，进行前置处理，创建操作辅助类，封装用例操作。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">default</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">DrawingRunner</span> <span style="color:#66d9ef">extends</span> <span style="color:#a6e22e">BaseRunner</span> {
  <span style="color:#66d9ef">private</span> <span style="color:#a6e22e">page</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">Frame</span>;
  <span style="color:#66d9ef">private</span> <span style="color:#a6e22e">canvasCenter</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">coordType</span>;
  <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">as</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">ActionStack</span>;
  <span style="color:#75715e">// 初始化，创建操作辅助类
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">constructor</span>(<span style="color:#66d9ef">public</span> <span style="color:#a6e22e">url</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">string</span>, <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">config</span><span style="color:#f92672">?:</span> <span style="color:#a6e22e">object</span>) {
    <span style="color:#66d9ef">super</span>(<span style="color:#a6e22e">url</span>, <span style="color:#a6e22e">config</span>);
    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">as</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">ActionStack</span>();
  }
  <span style="color:#75715e">// 设置该用例集的前置操作
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">async</span> <span style="color:#a6e22e">prepose</span>()<span style="color:#f92672">:</span> Promise<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">void</span><span style="color:#f92672">&gt;</span> {
    <span style="color:#66d9ef">await</span> <span style="color:#66d9ef">super</span>.<span style="color:#a6e22e">prepose</span>();
    <span style="color:#66d9ef">await</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">as</span>.<span style="color:#a6e22e">executeAction</span>(<span style="color:#e6db74">&#39;Get canvas centre position&#39;</span>, <span style="color:#66d9ef">async</span> () =&gt; {
      <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">originCanvas</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">page</span>.<span style="color:#a6e22e">$</span>(<span style="color:#e6db74">&#39;.origin-canvas&#39;</span>);
      <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">originBox</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">originCanvas</span>.<span style="color:#a6e22e">boundingBox</span>();
      <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">canvasCenter</span> <span style="color:#f92672">=</span> [<span style="color:#a6e22e">originBox</span>.<span style="color:#a6e22e">x</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">originBox</span>.<span style="color:#a6e22e">width</span> <span style="color:#f92672">/</span> <span style="color:#ae81ff">2</span>, <span style="color:#a6e22e">originBox</span>.<span style="color:#a6e22e">y</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">originBox</span>.<span style="color:#a6e22e">height</span> <span style="color:#f92672">/</span> <span style="color:#ae81ff">2</span>];
    });
  }
  <span style="color:#75715e">// 单独封装的操作
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">async</span> <span style="color:#a6e22e">clearDrawing</span>()<span style="color:#f92672">:</span> Promise<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">void</span><span style="color:#f92672">&gt;</span> {
    <span style="color:#66d9ef">await</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">as</span>.<span style="color:#a6e22e">executeAction</span>(<span style="color:#e6db74">&#39;Click clear drawing button&#39;</span>, <span style="color:#66d9ef">async</span> () =&gt; {
      <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">buttons</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">page</span>.<span style="color:#a6e22e">$$</span>(<span style="color:#e6db74">&#39;.edit-buttons .el-button&#39;</span>);
      <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">clearButton</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">buttons</span>.<span style="color:#a6e22e">pop</span>();
      <span style="color:#a6e22e">clearButton</span>.<span style="color:#a6e22e">click</span>();
    });
  }
  <span style="color:#75715e">// 测试用例操作
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">async</span> <span style="color:#a6e22e">runStrokeDrawing</span>()<span style="color:#f92672">:</span> Promise<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">void</span><span style="color:#f92672">&gt;</span> {
    <span style="color:#66d9ef">const</span> { <span style="color:#a6e22e">page</span>, <span style="color:#a6e22e">route</span> } <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>;
    <span style="color:#66d9ef">await</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">as</span>.<span style="color:#a6e22e">executeAction</span>(<span style="color:#e6db74">&#39;Draw keep type pen path&#39;</span>, <span style="color:#66d9ef">async</span> () =&gt; {
      <span style="color:#75715e">// drawing mode =&gt; keep (default)
</span><span style="color:#75715e"></span>      <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">dragByRoute</span>(<span style="color:#a6e22e">page</span>, <span style="color:#a6e22e">route</span>, <span style="color:#66d9ef">true</span>);
    });
    <span style="color:#66d9ef">await</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">as</span>.<span style="color:#a6e22e">executeAction</span>(<span style="color:#e6db74">&#39;Draw drop type pen path&#39;</span>, <span style="color:#66d9ef">async</span> () =&gt; {
      <span style="color:#75715e">// drawing mode =&gt; drop
</span><span style="color:#75715e"></span>      <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">page</span>.<span style="color:#a6e22e">click</span>(<span style="color:#e6db74">&#39;#drop-button&#39;</span>);
      <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">dragByRoute</span>(<span style="color:#a6e22e">page</span>, <span style="color:#a6e22e">route</span>, <span style="color:#66d9ef">true</span>);
    });
    <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">page</span>.<span style="color:#a6e22e">screenshot</span>({
      <span style="color:#a6e22e">path</span><span style="color:#f92672">:</span> <span style="color:#e6db74">`/e2e/shortcuts/case/stroke-drwaing.png`</span>
    });
  }
}
</code></pre></div><h2 id="与测试工具绑定">与测试工具绑定</h2>
<p>当编写完runner后，就该与测试工具绑定了，用于测试集的运行、结果判定等。</p>
<p>可以选择mocha或jest等工具，这里采用mocha进行演示。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#66d9ef">import</span> <span style="color:#e6db74">&#39;mocha&#39;</span>;
<span style="color:#66d9ef">import</span> <span style="color:#a6e22e">DrawingRunner</span> <span style="color:#a6e22e">from</span> <span style="color:#e6db74">&#39;@case/drawing&#39;</span>;
<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">url</span>  <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;YOUR_ADDRESS&#39;</span>;
<span style="color:#a6e22e">describe</span>(<span style="color:#e6db74">&#39;matting e2e test&#39;</span>, <span style="color:#66d9ef">function</span> () {
  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">runner</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">DrawingRunner</span>;
  <span style="color:#75715e">// 在各种hooks中执行对应操作
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">before</span>(<span style="color:#66d9ef">async</span> <span style="color:#66d9ef">function</span>() {
    <span style="color:#a6e22e">runner</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">DrawingRunner</span>(<span style="color:#a6e22e">url</span>, { <span style="color:#a6e22e">headless</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">true</span> });
    <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">runner</span>.<span style="color:#a6e22e">prepose</span>();
    <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">runner</span>.<span style="color:#a6e22e">clearDrawing</span>();
  });
  <span style="color:#75715e">// 每个用例执行前清空画布
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">beforeEach</span>(<span style="color:#66d9ef">async</span> <span style="color:#66d9ef">function</span>() {
    <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">runner</span>.<span style="color:#a6e22e">clearDrawing</span>();
  });
  <span style="color:#75715e">// 所有用例执行完释放资源
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">after</span>(<span style="color:#66d9ef">function</span>() {
    <span style="color:#a6e22e">runner</span>.<span style="color:#a6e22e">dispose</span>();
  });
  <span style="color:#75715e">// 执行用例
</span><span style="color:#75715e"></span>  <span style="color:#a6e22e">describe</span>(<span style="color:#e6db74">&#39;drawing case suite&#39;</span>, <span style="color:#66d9ef">function</span> () {
    <span style="color:#a6e22e">it</span>(<span style="color:#e6db74">&#39;stroke drwaing case&#39;</span>, <span style="color:#66d9ef">function</span> (<span style="color:#a6e22e">done</span>) {
      (<span style="color:#66d9ef">async</span> <span style="color:#66d9ef">function</span>() {
        <span style="color:#66d9ef">try</span> {
          <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">runner</span>.<span style="color:#a6e22e">runStrokeDrawing</span>();
        } <span style="color:#66d9ef">catch</span> (<span style="color:#a6e22e">e</span>) {
          <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">e</span>);
        }
        <span style="color:#a6e22e">done</span>();
      })();
    });
  });
});
</code></pre></div><h2 id="结果验证">结果验证</h2>
<p>在执行完用例还需要验证执行结果，canvas相关的测试有时无法单纯的通过判断元素或者具体数值来断言测试是否通过，需要使用一些额外的手段。</p>
<p>对于一般的canvas操作可以通过对比渲染结果图自动验证，对于复杂繁琐的交互也可以记录操作的动图人工验证。</p>
<h3 id="自动验证对比预置的标准渲染图像">自动验证：对比预置的标准渲染图像</h3>
<p>准备预置的操作结果渲染图像，截取测试结果的图像进行对比，验证是否符合预期。</p>
<p>在图像对比部分可以使用<a href="https://github.com/rsmbl/Resemble.js">Resemble.js</a>等图像分析与对比工具进行，将对比的结果传入断言函数中。</p>
<h3 id="人工验证记录操作流程动图">人工验证：记录操作流程动图</h3>
<p>可以使用gif工具记录下操作过程的动图并保存下来，之后进行人工验证，检查效果是否符合预期。</p>
<p>实现方法很多，这里以gifencoder与png-js为例举个栗子：</p>
<p><strong>准备GifRecorder方法</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">GIFEncoder</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">require</span>(<span style="color:#e6db74">&#34;gifencoder&#34;</span>);
<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">PNG</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">require</span>(<span style="color:#e6db74">&#34;png-js&#34;</span>);
<span style="color:#66d9ef">const</span> <span style="color:#a6e22e">decode</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">png</span> =&gt; {
  <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> Promise(<span style="color:#a6e22e">r</span> =&gt; {
    <span style="color:#a6e22e">png</span>.<span style="color:#a6e22e">decode</span>(<span style="color:#a6e22e">pixels</span> =&gt; <span style="color:#a6e22e">r</span>(<span style="color:#a6e22e">pixels</span>));
  });
};

<span style="color:#75715e">// 截图并添加到gif frame中
</span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">gifAddFrame</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">async</span> (<span style="color:#a6e22e">page</span>, <span style="color:#a6e22e">encoder</span>, <span style="color:#a6e22e">snapshotRect</span>) =&gt; {
  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">clipRect</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">snapshotRect</span> <span style="color:#f92672">||</span> { <span style="color:#a6e22e">width</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">1024</span>, <span style="color:#a6e22e">height</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">768</span>, <span style="color:#a6e22e">x</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">y</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0</span> };
  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">pngBuffer</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">page</span>.<span style="color:#a6e22e">screenshot</span>({ <span style="color:#a6e22e">clip</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">clipRect</span> });
  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">png</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">PNG</span>(<span style="color:#a6e22e">pngBuffer</span>);
  <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">decode</span>(<span style="color:#a6e22e">png</span>).<span style="color:#a6e22e">then</span>(<span style="color:#a6e22e">pixels</span> =&gt; <span style="color:#a6e22e">encoder</span>.<span style="color:#a6e22e">addFrame</span>(<span style="color:#a6e22e">pixels</span>));
};

<span style="color:#75715e">// 创建gif记录器
</span><span style="color:#75715e"></span><span style="color:#a6e22e">exports</span>.<span style="color:#a6e22e">initGifRecorder</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">page</span>, <span style="color:#a6e22e">filename</span>, <span style="color:#a6e22e">filePath</span>, <span style="color:#a6e22e">interval</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">300</span>) =&gt; {
  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">encoder</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">GIFEncoder</span>(<span style="color:#ae81ff">1024</span>, <span style="color:#ae81ff">768</span>);
  <span style="color:#a6e22e">encoder</span>.<span style="color:#a6e22e">createWriteStream</span>().<span style="color:#a6e22e">pipe</span>(<span style="color:#a6e22e">fs</span>.<span style="color:#a6e22e">createWriteStream</span>(<span style="color:#e6db74">`</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">filePath</span><span style="color:#e6db74">}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">${</span><span style="color:#a6e22e">filename</span><span style="color:#e6db74">}</span><span style="color:#e6db74">.gif`</span>));
  <span style="color:#a6e22e">encoder</span>.<span style="color:#a6e22e">start</span>();
  <span style="color:#a6e22e">encoder</span>.<span style="color:#a6e22e">setRepeat</span>(<span style="color:#ae81ff">0</span>);
  <span style="color:#a6e22e">encoder</span>.<span style="color:#a6e22e">setDelay</span>(<span style="color:#ae81ff">300</span>);
  <span style="color:#a6e22e">encoder</span>.<span style="color:#a6e22e">setQuality</span>(<span style="color:#ae81ff">10</span>);
  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">timer</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">setInterval</span>(() =&gt; <span style="color:#a6e22e">gifAddFrame</span>(<span style="color:#a6e22e">page</span>, <span style="color:#a6e22e">encoder</span>), <span style="color:#a6e22e">interval</span>);
  <span style="color:#66d9ef">return</span> () =&gt; {
    <span style="color:#a6e22e">clearInterval</span>(<span style="color:#a6e22e">timer</span>);
    <span style="color:#a6e22e">encoder</span>.<span style="color:#a6e22e">finish</span>();
  };
};
</code></pre></div><p><strong>在需要记录的操作处调用</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">initGifRecorder</span> } <span style="color:#a6e22e">from</span> <span style="color:#e6db74">&#39;@helper/utils&#39;</span>
<span style="color:#66d9ef">export</span> <span style="color:#66d9ef">default</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">DrawingRunner</span> <span style="color:#66d9ef">extends</span> <span style="color:#a6e22e">BaseRunner</span> {
  <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">async</span> <span style="color:#a6e22e">runStrokeDrawing</span>()<span style="color:#f92672">:</span> Promise<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">void</span><span style="color:#f92672">&gt;</span> {
    <span style="color:#66d9ef">const</span> { <span style="color:#a6e22e">page</span>, <span style="color:#a6e22e">route</span> } <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>;
    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">stopRecorder</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">initGifRecorder</span>(<span style="color:#a6e22e">page</span>, <span style="color:#e6db74">&#39;stroke-drawing&#39;</span>, <span style="color:#e6db74">&#39;e2e/gif&#39;</span>) <span style="color:#75715e">// 开始记录
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// 操作...
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">stopRecorder</span>(); <span style="color:#75715e">// 停止记录
</span><span style="color:#75715e"></span>  }
}
</code></pre></div><h2 id="其他">其他</h2>
<p>一个pptr与jest集成的例子</p>
<ul>
<li><a href="https://github.com/smooth-code/jest-puppeteer">jest-puppeteer</a></li>
</ul>
<h2 id="参考">参考</h2>
<ol>
<li><a href="https://medium.com/uptake-tech/using-puppeteer-to-create-an-end-to-end-test-framework-f1e7e008c793">Using Puppeteer to Create an End-to-End Test Framework</a></li>
<li><a href="https://www.w3.org/TR/webdriver/">WebDriver</a></li>
<li><a href="https://itnext.io/getting-started-using-puppeteer-headless-chrome-for-end-to-end-testing-8487718e4d97">Getting Started Using Puppeteer &amp; Headless Chrome for End-to-End Testing</a></li>
<li><a href="http://verbosity.ca/javascript/2018-07-23-testing-with-mocha-chai-and-puppeteer">Testing with mocha, chai, and puppeteer</a></li>
</ol>
        </div>

        
<div class="post-archive">
    <ul class="post-copyright">
        <li><strong>原文作者：</strong><a rel="author" href="http://yrq110.me/">yrq110</a></li>
        <li style="word-break:break-all"><strong>原文链接：</strong><a href="http://yrq110.me/post/front-end/practice-in-e2e-test-with-puppeteer/">http://yrq110.me/post/front-end/practice-in-e2e-test-with-puppeteer/</a></li>
        <li><strong>版权声明：</strong>本作品采用<a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/4.0/">知识共享署名-非商业性使用-禁止演绎 4.0 国际许可协议</a>进行许可，非商业转载请注明出处（作者，原文链接），商业转载请联系作者获得授权。</li>
    </ul>
</div>
<br/>



        

<div class="post-archive">
    <h2>See Also</h2>
    <ul class="listing">
        
        <li><a href="/post/front-end/offscreen-canvas-practice/">Worker中的OffscreenCanvas渲染实践与浅析</a></li>
        
        <li><a href="/post/front-end/canvas-travel/">Canvas从小试牛刀到庖丁解牛</a></li>
        
        <li><a href="/post/front-end/canvas-effect-snippets/">Canvas效果片段</a></li>
        
        <li><a href="/post/front-end/swim-in-shallow-puppeteer-api/">Puppeteer常用API浅析</a></li>
        
        <li><a href="/post/front-end/some-tips-of-using-puppetter/">几个Puppeteer使用小技巧</a></li>
        
    </ul>
</div>


        <div class="post-meta meta-tags">
            
            <ul class="clearfix">
                
                <li><a href='/tags/puppeteer'>puppeteer</a></li>
                
                <li><a href='/tags/e2e'>e2e</a></li>
                
                <li><a href='/tags/canvas'>canvas</a></li>
                
            </ul>
            
        </div>
    </article>
    
    

    
    
    <div class="post bg-white">
      <script src="https://utteranc.es/client.js"
            repo= "yrq110/blog-comments"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
      </script>
    </div>
    
</div>

                    <footer id="footer">
    <div>
        &copy; 2021 <a href="http://yrq110.me/">￥ЯႭ1I0 By yrq110</a>
        
    </div>
    <br />
    <div>
        <div class="github-badge">
            <a href="https://gohugo.io/" target="_black" rel="nofollow"><span class="badge-subject">Powered by</span><span class="badge-value bg-blue">Hugo</span></a>
        </div>
        <div class="github-badge">
            <a href="https://www.flysnow.org/" target="_black"><span class="badge-subject">Design by</span><span class="badge-value bg-brightgreen">飞雪无情</span></a>
        </div>
        <div class="github-badge">
            <a href="https://github.com/flysnow-org/maupassant-hugo" target="_black"><span class="badge-subject">Theme</span><span class="badge-value bg-yellowgreen">Maupassant</span></a>
        </div>
    </div>
</footer>


    
    <script type="text/javascript">
        window.MathJax = {
            tex2jax: {
                inlineMath: [['$', '$']],
                processEscapes: true
                }
            };
    </script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML' async></script>

<a id="rocket" href="#top"></a>
<script type="text/javascript" src='/js/totop.js?v=0.0.0' async=""></script>

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-131471642-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>






                </div>

                <div id="secondary">
    <section class="widget">
        <form id="search" action='//www.google.com/search' method="get" accept-charset="utf-8" target="_blank" _lpchecked="1">
      
      <input type="text" name="q" maxlength="20" placeholder="Search">
      <input type="hidden" name="sitesearch" value="http://yrq110.me/">
      <button type="submit" class="submit icon-search"></button>
</form>
    </section>
    
    <section class="widget">
        <h3 class="widget-title">最近文章</h3>
<ul class="widget-list">
    
    <li>
        <a href="http://yrq110.me/post/computer-graphics/camera-calibration-basic/" title="相机标定中的投影与畸变处理">相机标定中的投影与畸变处理</a>
    </li>
    
    <li>
        <a href="http://yrq110.me/post/front-end/contents-about-blink-web-worker/" title="Blink Worker纸上谈兵">Blink Worker纸上谈兵</a>
    </li>
    
    <li>
        <a href="http://yrq110.me/post/front-end/mapboxgl-ii-transform/" title="MapboxGL简析(二)：变换">MapboxGL简析(二)：变换</a>
    </li>
    
    <li>
        <a href="http://yrq110.me/post/front-end/mapboxgl-i-rendering/" title="MapboxGL简析(一)：渲染">MapboxGL简析(一)：渲染</a>
    </li>
    
    <li>
        <a href="http://yrq110.me/post/front-end/deep-in-threejs-core-objects-iii-material/" title="深入学习Three.js核心对象之（三）Material">深入学习Three.js核心对象之（三）Material</a>
    </li>
    
    <li>
        <a href="http://yrq110.me/post/front-end/deep-in-threejs-core-objects-ii-geometry/" title="深入学习Three.js核心对象之（二）Geometry">深入学习Three.js核心对象之（二）Geometry</a>
    </li>
    
    <li>
        <a href="http://yrq110.me/post/front-end/deep-in-threejs-core-objects-i-object3d/" title="深入学习Three.js核心对象之（一）Object3D">深入学习Three.js核心对象之（一）Object3D</a>
    </li>
    
    <li>
        <a href="http://yrq110.me/post/computer-graphics/euler-angles-gimbal-lock-and-quaternion/" title="欧拉角、万向节死锁与四元数">欧拉角、万向节死锁与四元数</a>
    </li>
    
    <li>
        <a href="http://yrq110.me/post/front-end/cross-domain-and-cross-document-communication/" title="Web通信中的跨文档通信">Web通信中的跨文档通信</a>
    </li>
    
    <li>
        <a href="http://yrq110.me/post/front-end/typescript-decorator-practice/" title="TypeScript装饰器整理及用例介绍">TypeScript装饰器整理及用例介绍</a>
    </li>
    
</ul>
    </section>

    

    <section class="widget">
        <h3 class="widget-title"><a href='/categories/'>分类</a></h3>
<ul class="widget-list">
    
    <li><a href="http://yrq110.me/categories/computer-graphics/">computer-graphics (2)</a></li>
    
    <li><a href="http://yrq110.me/categories/database/">database (2)</a></li>
    
    <li><a href="http://yrq110.me/categories/devops/">devops (5)</a></li>
    
    <li><a href="http://yrq110.me/categories/front-end/">front-end (26)</a></li>
    
    <li><a href="http://yrq110.me/categories/go/">go (1)</a></li>
    
    <li><a href="http://yrq110.me/categories/practice/">practice (2)</a></li>
    
</ul>
    </section>

    <section class="widget">
        <h3 class="widget-title"><a href='/tags/'>标签</a></h3>
<div class="tagcloud">
    
    <a href="http://yrq110.me/tags/blink/">blink</a>
    
    <a href="http://yrq110.me/tags/calibration/">calibration</a>
    
    <a href="http://yrq110.me/tags/canvas/">canvas</a>
    
    <a href="http://yrq110.me/tags/chrome/">chrome</a>
    
    <a href="http://yrq110.me/tags/chromium/">chromium</a>
    
    <a href="http://yrq110.me/tags/cross-document/">cross-document</a>
    
    <a href="http://yrq110.me/tags/css/">css</a>
    
    <a href="http://yrq110.me/tags/docker/">docker</a>
    
    <a href="http://yrq110.me/tags/dom/">dom</a>
    
    <a href="http://yrq110.me/tags/e2e/">e2e</a>
    
    <a href="http://yrq110.me/tags/electron/">electron</a>
    
    <a href="http://yrq110.me/tags/event-loop/">event-loop</a>
    
    <a href="http://yrq110.me/tags/fabric/">fabric</a>
    
    <a href="http://yrq110.me/tags/git/">git</a>
    
    <a href="http://yrq110.me/tags/git-submodule/">git-submodule</a>
    
    <a href="http://yrq110.me/tags/github/">github</a>
    
    <a href="http://yrq110.me/tags/gpu/">gpu</a>
    
    <a href="http://yrq110.me/tags/houdini/">houdini</a>
    
    <a href="http://yrq110.me/tags/hugo/">hugo</a>
    
    <a href="http://yrq110.me/tags/iframe/">iframe</a>
    
    <a href="http://yrq110.me/tags/konva/">konva</a>
    
    <a href="http://yrq110.me/tags/lerna/">lerna</a>
    
    <a href="http://yrq110.me/tags/libuv/">libuv</a>
    
    <a href="http://yrq110.me/tags/mapbox/">mapbox</a>
    
    <a href="http://yrq110.me/tags/maupassant/">maupassant</a>
    
    <a href="http://yrq110.me/tags/mongo/">mongo</a>
    
    <a href="http://yrq110.me/tags/mpvue/">mpvue</a>
    
    <a href="http://yrq110.me/tags/node/">node</a>
    
    <a href="http://yrq110.me/tags/offscreen-canvas/">offscreen canvas</a>
    
    <a href="http://yrq110.me/tags/pixi/">pixi</a>
    
    <a href="http://yrq110.me/tags/playwright/">playwright</a>
    
    <a href="http://yrq110.me/tags/postmessage/">postMessage</a>
    
    <a href="http://yrq110.me/tags/puppeteer/">puppeteer</a>
    
    <a href="http://yrq110.me/tags/quaternion/">quaternion</a>
    
    <a href="http://yrq110.me/tags/rendering-pipeline/">rendering pipeline</a>
    
    <a href="http://yrq110.me/tags/rotation/">rotation</a>
    
    <a href="http://yrq110.me/tags/skia/">skia</a>
    
    <a href="http://yrq110.me/tags/ssh/">ssh</a>
    
    <a href="http://yrq110.me/tags/svg/">svg</a>
    
    <a href="http://yrq110.me/tags/threejs/">threejs</a>
    
    <a href="http://yrq110.me/tags/typescript/">typescript</a>
    
    <a href="http://yrq110.me/tags/vue/">vue</a>
    
    <a href="http://yrq110.me/tags/web-worker/">web worker</a>
    
    <a href="http://yrq110.me/tags/webgpu/">webgpu</a>
    
    <a href="http://yrq110.me/tags/websocket/">websocket</a>
    
    <a href="http://yrq110.me/tags/wxapp/">wxapp</a>
    
    <a href="http://yrq110.me/tags/yarn/">yarn</a>
    
</div>
    </section>

    
<section class="widget">
    <h3 class="widget-title">友情链接</h3>
    <ul class="widget-list">
        
        <li>
            <a target="_blank" href="https://taoyuan.fun/" title="taoyuan">taoyuan</a>
        </li>
        
        <li>
            <a target="_blank" href="https://blog.cshayne.cn/" title="cshayne">cshayne</a>
        </li>
        
    </ul>
</section>


    <section class="widget">
        <h3 class="widget-title">其它</h3>
        <ul class="widget-list">
            <li><a href="http://yrq110.me/index.xml">文章 RSS</a></li>
        </ul>
    </section>
</div>
            </div>
        </div>
    </div>
</body>

</html>